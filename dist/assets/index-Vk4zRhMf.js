import{createClient as fr}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";function pr(r,e){for(var t=0;t<e.length;t++){const s=e[t];if(typeof s!="string"&&!Array.isArray(s)){for(const i in s)if(i!=="default"&&!(i in r)){const n=Object.getOwnPropertyDescriptor(s,i);n&&Object.defineProperty(r,i,n.get?n:{enumerable:!0,get:()=>s[i]})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();var ot=function(r,e){return ot=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])},ot(r,e)};function is(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");ot(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var Ve=function(){return Ve=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++){t=arguments[s];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},Ve.apply(this,arguments)};function Ee(r,e){var t={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&e.indexOf(s)<0&&(t[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,s=Object.getOwnPropertySymbols(r);i<s.length;i++)e.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(r,s[i])&&(t[s[i]]=r[s[i]]);return t}function ns(r,e,t,s){var i=arguments.length,n=i<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(r,e,t,s);else for(var o=r.length-1;o>=0;o--)(a=r[o])&&(n=(i<3?a(n):i>3?a(e,t,n):a(e,t))||n);return i>3&&n&&Object.defineProperty(e,t,n),n}function as(r,e){return function(t,s){e(t,s,r)}}function os(r,e,t,s,i,n){function a(E){if(E!==void 0&&typeof E!="function")throw new TypeError("Function expected");return E}for(var o=s.kind,c=o==="getter"?"get":o==="setter"?"set":"value",l=!e&&r?s.static?r:r.prototype:null,d=e||(l?Object.getOwnPropertyDescriptor(l,s.name):{}),h,u=!1,f=t.length-1;f>=0;f--){var p={};for(var g in s)p[g]=g==="access"?{}:s[g];for(var g in s.access)p.access[g]=s.access[g];p.addInitializer=function(E){if(u)throw new TypeError("Cannot add initializers after decoration has completed");n.push(a(E||null))};var v=(0,t[f])(o==="accessor"?{get:d.get,set:d.set}:d[c],p);if(o==="accessor"){if(v===void 0)continue;if(v===null||typeof v!="object")throw new TypeError("Object expected");(h=a(v.get))&&(d.get=h),(h=a(v.set))&&(d.set=h),(h=a(v.init))&&i.unshift(h)}else(h=a(v))&&(o==="field"?i.unshift(h):d[c]=h)}l&&Object.defineProperty(l,s.name,d),u=!0}function cs(r,e,t){for(var s=arguments.length>2,i=0;i<e.length;i++)t=s?e[i].call(r,t):e[i].call(r);return s?t:void 0}function ls(r){return typeof r=="symbol"?r:"".concat(r)}function ds(r,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(r,"name",{configurable:!0,value:t?"".concat(t," ",e):e})}function us(r,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,e)}function S(r,e,t,s){function i(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function o(d){try{l(s.next(d))}catch(h){a(h)}}function c(d){try{l(s.throw(d))}catch(h){a(h)}}function l(d){d.done?n(d.value):i(d.value).then(o,c)}l((s=s.apply(r,e||[])).next())})}function hs(r,e){var t={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},s,i,n,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(d){return c([l,d])}}function c(l){if(s)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(t=0)),t;)try{if(s=1,i&&(n=l[0]&2?i.return:l[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,l[1])).done)return n;switch(i=0,n&&(l=[l[0]&2,n.value]),l[0]){case 0:case 1:n=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,i=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(n=t.trys,!(n=n.length>0&&n[n.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!n||l[1]>n[0]&&l[1]<n[3])){t.label=l[1];break}if(l[0]===6&&t.label<n[1]){t.label=n[1],n=l;break}if(n&&t.label<n[2]){t.label=n[2],t.ops.push(l);break}n[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(d){l=[6,d],i=0}finally{s=n=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}var Ge=Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]};function fs(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Ge(e,r,t)}function He(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function wt(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),i,n=[],a;try{for(;(e===void 0||e-- >0)&&!(i=s.next()).done;)n.push(i.value)}catch(o){a={error:o}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(a)throw a.error}}return n}function ps(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(wt(arguments[e]));return r}function ms(){for(var r=0,e=0,t=arguments.length;e<t;e++)r+=arguments[e].length;for(var s=Array(r),i=0,e=0;e<t;e++)for(var n=arguments[e],a=0,o=n.length;a<o;a++,i++)s[i]=n[a];return s}function gs(r,e,t){if(t||arguments.length===2)for(var s=0,i=e.length,n;s<i;s++)(n||!(s in e))&&(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return r.concat(n||Array.prototype.slice.call(e))}function we(r){return this instanceof we?(this.v=r,this):new we(r)}function vs(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=t.apply(r,e||[]),i,n=[];return i=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",a),i[Symbol.asyncIterator]=function(){return this},i;function a(f){return function(p){return Promise.resolve(p).then(f,h)}}function o(f,p){s[f]&&(i[f]=function(g){return new Promise(function(v,E){n.push([f,g,v,E])>1||c(f,g)})},p&&(i[f]=p(i[f])))}function c(f,p){try{l(s[f](p))}catch(g){u(n[0][3],g)}}function l(f){f.value instanceof we?Promise.resolve(f.value.v).then(d,h):u(n[0][2],f)}function d(f){c("next",f)}function h(f){c("throw",f)}function u(f,p){f(p),n.shift(),n.length&&c(n[0][0],n[0][1])}}function ys(r){var e,t;return e={},s("next"),s("throw",function(i){throw i}),s("return"),e[Symbol.iterator]=function(){return this},e;function s(i,n){e[i]=r[i]?function(a){return(t=!t)?{value:we(r[i](a)),done:!1}:n?n(a):a}:n}}function bs(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=r[Symbol.asyncIterator],t;return e?e.call(r):(r=typeof He=="function"?He(r):r[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(n){t[n]=r[n]&&function(a){return new Promise(function(o,c){a=r[n](a),i(o,c,a.done,a.value)})}}function i(n,a,o,c){Promise.resolve(c).then(function(l){n({value:l,done:o})},a)}}function ws(r,e){return Object.defineProperty?Object.defineProperty(r,"raw",{value:e}):r.raw=e,r}var mr=Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e},ct=function(r){return ct=Object.getOwnPropertyNames||function(e){var t=[];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[t.length]=s);return t},ct(r)};function _s(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t=ct(r),s=0;s<t.length;s++)t[s]!=="default"&&Ge(e,r,t[s]);return mr(e,r),e}function Es(r){return r&&r.__esModule?r:{default:r}}function Ss(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)}function ks(r,e,t,s,i){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t}function Cs(r,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof r=="function"?e===r:r.has(e)}function Os(r,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var s,i;if(t){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");s=e[Symbol.asyncDispose]}if(s===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");s=e[Symbol.dispose],t&&(i=s)}if(typeof s!="function")throw new TypeError("Object not disposable.");i&&(s=function(){try{i.call(this)}catch(n){return Promise.reject(n)}}),r.stack.push({value:e,dispose:s,async:t})}else t&&r.stack.push({async:!0});return e}var gr=typeof SuppressedError=="function"?SuppressedError:function(r,e,t){var s=new Error(t);return s.name="SuppressedError",s.error=r,s.suppressed=e,s};function js(r){function e(n){r.error=r.hasError?new gr(n,r.error,"An error was suppressed during disposal."):n,r.hasError=!0}var t,s=0;function i(){for(;t=r.stack.pop();)try{if(!t.async&&s===1)return s=0,r.stack.push(t),Promise.resolve().then(i);if(t.dispose){var n=t.dispose.call(t.value);if(t.async)return s|=2,Promise.resolve(n).then(i,function(a){return e(a),i()})}else s|=1}catch(a){e(a)}if(s===1)return r.hasError?Promise.reject(r.error):Promise.resolve();if(r.hasError)throw r.error}return i()}function Ts(r,e){return typeof r=="string"&&/^\.\.?\//.test(r)?r.replace(/\.(tsx)$|((?:\.d)?)((?:\.[^./]+?)?)\.([cm]?)ts$/i,function(t,s,i,n,a){return s?e?".jsx":".js":i&&(!n||!a)?t:i+n+"."+a.toLowerCase()+"js"}):r}const vr={__extends:is,__assign:Ve,__rest:Ee,__decorate:ns,__param:as,__esDecorate:os,__runInitializers:cs,__propKey:ls,__setFunctionName:ds,__metadata:us,__awaiter:S,__generator:hs,__createBinding:Ge,__exportStar:fs,__values:He,__read:wt,__spread:ps,__spreadArrays:ms,__spreadArray:gs,__await:we,__asyncGenerator:vs,__asyncDelegator:ys,__asyncValues:bs,__makeTemplateObject:ws,__importStar:_s,__importDefault:Es,__classPrivateFieldGet:Ss,__classPrivateFieldSet:ks,__classPrivateFieldIn:Cs,__addDisposableResource:Os,__disposeResources:js,__rewriteRelativeImportExtension:Ts},yr=Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:Os,get __assign(){return Ve},__asyncDelegator:ys,__asyncGenerator:vs,__asyncValues:bs,__await:we,__awaiter:S,__classPrivateFieldGet:Ss,__classPrivateFieldIn:Cs,__classPrivateFieldSet:ks,__createBinding:Ge,__decorate:ns,__disposeResources:js,__esDecorate:os,__exportStar:fs,__extends:is,__generator:hs,__importDefault:Es,__importStar:_s,__makeTemplateObject:ws,__metadata:us,__param:as,__propKey:ls,__read:wt,__rest:Ee,__rewriteRelativeImportExtension:Ts,__runInitializers:cs,__setFunctionName:ds,__spread:ps,__spreadArray:gs,__spreadArrays:ms,__values:He,default:vr},Symbol.toStringTag,{value:"Module"})),br=r=>r?(...e)=>r(...e):(...e)=>fetch(...e);class _t extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class wr extends _t{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Rt extends _t{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Pt extends _t{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var lt;(function(r){r.Any="any",r.ApNortheast1="ap-northeast-1",r.ApNortheast2="ap-northeast-2",r.ApSouth1="ap-south-1",r.ApSoutheast1="ap-southeast-1",r.ApSoutheast2="ap-southeast-2",r.CaCentral1="ca-central-1",r.EuCentral1="eu-central-1",r.EuWest1="eu-west-1",r.EuWest2="eu-west-2",r.EuWest3="eu-west-3",r.SaEast1="sa-east-1",r.UsEast1="us-east-1",r.UsWest1="us-west-1",r.UsWest2="us-west-2"})(lt||(lt={}));class _r{constructor(e,{headers:t={},customFetch:s,region:i=lt.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=br(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return S(this,arguments,void 0,function*(t,s={}){var i;let n,a;try{const{headers:o,method:c,body:l,signal:d,timeout:h}=s;let u={},{region:f}=s;f||(f=this.region);const p=new URL(`${this.url}/${t}`);f&&f!=="any"&&(u["x-region"]=f,p.searchParams.set("forceFunctionRegion",f));let g;l&&(o&&!Object.prototype.hasOwnProperty.call(o,"Content-Type")||!o)?typeof Blob<"u"&&l instanceof Blob||l instanceof ArrayBuffer?(u["Content-Type"]="application/octet-stream",g=l):typeof l=="string"?(u["Content-Type"]="text/plain",g=l):typeof FormData<"u"&&l instanceof FormData?g=l:(u["Content-Type"]="application/json",g=JSON.stringify(l)):g=l;let v=d;h&&(a=new AbortController,n=setTimeout(()=>a.abort(),h),d?(v=a.signal,d.addEventListener("abort",()=>a.abort())):v=a.signal);const E=yield this.fetch(p.toString(),{method:c||"POST",headers:Object.assign(Object.assign(Object.assign({},u),this.headers),o),body:g,signal:v}).catch(T=>{throw new wr(T)}),_=E.headers.get("x-relay-error");if(_&&_==="true")throw new Rt(E);if(!E.ok)throw new Pt(E);let m=((i=E.headers.get("Content-Type"))!==null&&i!==void 0?i:"text/plain").split(";")[0].trim(),b;return m==="application/json"?b=yield E.json():m==="application/octet-stream"||m==="application/pdf"?b=yield E.blob():m==="text/event-stream"?b=E:m==="multipart/form-data"?b=yield E.formData():b=yield E.text(),{data:b,error:null,response:E}}catch(o){return{data:null,error:o,response:o instanceof Pt||o instanceof Rt?o.context:void 0}}finally{n&&clearTimeout(n)}})}}function Er(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(s){var i=Object.getOwnPropertyDescriptor(r,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return r[s]}})}),t}var F={};const Se=Er(yr);var $e={},Ne={},Le={},Ue={},qe={},De={},It;function As(){if(It)return De;It=1,Object.defineProperty(De,"__esModule",{value:!0});class r extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}}return De.default=r,De}var xt;function Rs(){if(xt)return qe;xt=1,Object.defineProperty(qe,"__esModule",{value:!0});const e=Se.__importDefault(As());class t{constructor(i){var n,a;this.shouldThrowOnError=!1,this.method=i.method,this.url=i.url,this.headers=new Headers(i.headers),this.schema=i.schema,this.body=i.body,this.shouldThrowOnError=(n=i.shouldThrowOnError)!==null&&n!==void 0?n:!1,this.signal=i.signal,this.isMaybeSingle=(a=i.isMaybeSingle)!==null&&a!==void 0?a:!1,i.fetch?this.fetch=i.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(i,n){return this.headers=new Headers(this.headers),this.headers.set(i,n),this}then(i,n){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const a=this.fetch;let o=a(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async c=>{var l,d,h,u;let f=null,p=null,g=null,v=c.status,E=c.statusText;if(c.ok){if(this.method!=="HEAD"){const T=await c.text();T===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((l=this.headers.get("Accept"))===null||l===void 0)&&l.includes("application/vnd.pgrst.plan+text"))?p=T:p=JSON.parse(T))}const m=(d=this.headers.get("Prefer"))===null||d===void 0?void 0:d.match(/count=(exact|planned|estimated)/),b=(h=c.headers.get("content-range"))===null||h===void 0?void 0:h.split("/");m&&b&&b.length>1&&(g=parseInt(b[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(p)&&(p.length>1?(f={code:"PGRST116",details:`Results contain ${p.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},p=null,g=null,v=406,E="Not Acceptable"):p.length===1?p=p[0]:p=null)}else{const m=await c.text();try{f=JSON.parse(m),Array.isArray(f)&&c.status===404&&(p=[],f=null,v=200,E="OK")}catch{c.status===404&&m===""?(v=204,E="No Content"):f={message:m}}if(f&&this.isMaybeSingle&&(!((u=f==null?void 0:f.details)===null||u===void 0)&&u.includes("0 rows"))&&(f=null,v=200,E="OK"),f&&this.shouldThrowOnError)throw new e.default(f)}return{error:f,data:p,count:g,status:v,statusText:E}});return this.shouldThrowOnError||(o=o.catch(c=>{var l,d,h;return{error:{message:`${(l=c==null?void 0:c.name)!==null&&l!==void 0?l:"FetchError"}: ${c==null?void 0:c.message}`,details:`${(d=c==null?void 0:c.stack)!==null&&d!==void 0?d:""}`,hint:"",code:`${(h=c==null?void 0:c.code)!==null&&h!==void 0?h:""}`},data:null,count:null,status:0,statusText:""}})),o.then(i,n)}returns(){return this}overrideTypes(){return this}}return qe.default=t,qe}var $t;function Ps(){if($t)return Ue;$t=1,Object.defineProperty(Ue,"__esModule",{value:!0});const e=Se.__importDefault(Rs());class t extends e.default{select(i){let n=!1;const a=(i??"*").split("").map(o=>/\s/.test(o)&&!n?"":(o==='"'&&(n=!n),o)).join("");return this.url.searchParams.set("select",a),this.headers.append("Prefer","return=representation"),this}order(i,{ascending:n=!0,nullsFirst:a,foreignTable:o,referencedTable:c=o}={}){const l=c?`${c}.order`:"order",d=this.url.searchParams.get(l);return this.url.searchParams.set(l,`${d?`${d},`:""}${i}.${n?"asc":"desc"}${a===void 0?"":a?".nullsfirst":".nullslast"}`),this}limit(i,{foreignTable:n,referencedTable:a=n}={}){const o=typeof a>"u"?"limit":`${a}.limit`;return this.url.searchParams.set(o,`${i}`),this}range(i,n,{foreignTable:a,referencedTable:o=a}={}){const c=typeof o>"u"?"offset":`${o}.offset`,l=typeof o>"u"?"limit":`${o}.limit`;return this.url.searchParams.set(c,`${i}`),this.url.searchParams.set(l,`${n-i+1}`),this}abortSignal(i){return this.signal=i,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:i=!1,verbose:n=!1,settings:a=!1,buffers:o=!1,wal:c=!1,format:l="text"}={}){var d;const h=[i?"analyze":null,n?"verbose":null,a?"settings":null,o?"buffers":null,c?"wal":null].filter(Boolean).join("|"),u=(d=this.headers.get("Accept"))!==null&&d!==void 0?d:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${l}; for="${u}"; options=${h};`),l==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(i){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${i}`),this}}return Ue.default=t,Ue}var Nt;function Et(){if(Nt)return Le;Nt=1,Object.defineProperty(Le,"__esModule",{value:!0});const e=Se.__importDefault(Ps()),t=new RegExp("[,()]");class s extends e.default{eq(n,a){return this.url.searchParams.append(n,`eq.${a}`),this}neq(n,a){return this.url.searchParams.append(n,`neq.${a}`),this}gt(n,a){return this.url.searchParams.append(n,`gt.${a}`),this}gte(n,a){return this.url.searchParams.append(n,`gte.${a}`),this}lt(n,a){return this.url.searchParams.append(n,`lt.${a}`),this}lte(n,a){return this.url.searchParams.append(n,`lte.${a}`),this}like(n,a){return this.url.searchParams.append(n,`like.${a}`),this}likeAllOf(n,a){return this.url.searchParams.append(n,`like(all).{${a.join(",")}}`),this}likeAnyOf(n,a){return this.url.searchParams.append(n,`like(any).{${a.join(",")}}`),this}ilike(n,a){return this.url.searchParams.append(n,`ilike.${a}`),this}ilikeAllOf(n,a){return this.url.searchParams.append(n,`ilike(all).{${a.join(",")}}`),this}ilikeAnyOf(n,a){return this.url.searchParams.append(n,`ilike(any).{${a.join(",")}}`),this}is(n,a){return this.url.searchParams.append(n,`is.${a}`),this}in(n,a){const o=Array.from(new Set(a)).map(c=>typeof c=="string"&&t.test(c)?`"${c}"`:`${c}`).join(",");return this.url.searchParams.append(n,`in.(${o})`),this}contains(n,a){return typeof a=="string"?this.url.searchParams.append(n,`cs.${a}`):Array.isArray(a)?this.url.searchParams.append(n,`cs.{${a.join(",")}}`):this.url.searchParams.append(n,`cs.${JSON.stringify(a)}`),this}containedBy(n,a){return typeof a=="string"?this.url.searchParams.append(n,`cd.${a}`):Array.isArray(a)?this.url.searchParams.append(n,`cd.{${a.join(",")}}`):this.url.searchParams.append(n,`cd.${JSON.stringify(a)}`),this}rangeGt(n,a){return this.url.searchParams.append(n,`sr.${a}`),this}rangeGte(n,a){return this.url.searchParams.append(n,`nxl.${a}`),this}rangeLt(n,a){return this.url.searchParams.append(n,`sl.${a}`),this}rangeLte(n,a){return this.url.searchParams.append(n,`nxr.${a}`),this}rangeAdjacent(n,a){return this.url.searchParams.append(n,`adj.${a}`),this}overlaps(n,a){return typeof a=="string"?this.url.searchParams.append(n,`ov.${a}`):this.url.searchParams.append(n,`ov.{${a.join(",")}}`),this}textSearch(n,a,{config:o,type:c}={}){let l="";c==="plain"?l="pl":c==="phrase"?l="ph":c==="websearch"&&(l="w");const d=o===void 0?"":`(${o})`;return this.url.searchParams.append(n,`${l}fts${d}.${a}`),this}match(n){return Object.entries(n).forEach(([a,o])=>{this.url.searchParams.append(a,`eq.${o}`)}),this}not(n,a,o){return this.url.searchParams.append(n,`not.${a}.${o}`),this}or(n,{foreignTable:a,referencedTable:o=a}={}){const c=o?`${o}.or`:"or";return this.url.searchParams.append(c,`(${n})`),this}filter(n,a,o){return this.url.searchParams.append(n,`${a}.${o}`),this}}return Le.default=s,Le}var Lt;function Is(){if(Lt)return Ne;Lt=1,Object.defineProperty(Ne,"__esModule",{value:!0});const e=Se.__importDefault(Et());class t{constructor(i,{headers:n={},schema:a,fetch:o}){this.url=i,this.headers=new Headers(n),this.schema=a,this.fetch=o}select(i,n){const{head:a=!1,count:o}=n??{},c=a?"HEAD":"GET";let l=!1;const d=(i??"*").split("").map(h=>/\s/.test(h)&&!l?"":(h==='"'&&(l=!l),h)).join("");return this.url.searchParams.set("select",d),o&&this.headers.append("Prefer",`count=${o}`),new e.default({method:c,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(i,{count:n,defaultToNull:a=!0}={}){var o;const c="POST";if(n&&this.headers.append("Prefer",`count=${n}`),a||this.headers.append("Prefer","missing=default"),Array.isArray(i)){const l=i.reduce((d,h)=>d.concat(Object.keys(h)),[]);if(l.length>0){const d=[...new Set(l)].map(h=>`"${h}"`);this.url.searchParams.set("columns",d.join(","))}}return new e.default({method:c,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}upsert(i,{onConflict:n,ignoreDuplicates:a=!1,count:o,defaultToNull:c=!0}={}){var l;const d="POST";if(this.headers.append("Prefer",`resolution=${a?"ignore":"merge"}-duplicates`),n!==void 0&&this.url.searchParams.set("on_conflict",n),o&&this.headers.append("Prefer",`count=${o}`),c||this.headers.append("Prefer","missing=default"),Array.isArray(i)){const h=i.reduce((u,f)=>u.concat(Object.keys(f)),[]);if(h.length>0){const u=[...new Set(h)].map(f=>`"${f}"`);this.url.searchParams.set("columns",u.join(","))}}return new e.default({method:d,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:(l=this.fetch)!==null&&l!==void 0?l:fetch})}update(i,{count:n}={}){var a;const o="PATCH";return n&&this.headers.append("Prefer",`count=${n}`),new e.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch})}delete({count:i}={}){var n;const a="DELETE";return i&&this.headers.append("Prefer",`count=${i}`),new e.default({method:a,url:this.url,headers:this.headers,schema:this.schema,fetch:(n=this.fetch)!==null&&n!==void 0?n:fetch})}}return Ne.default=t,Ne}var Ut;function Sr(){if(Ut)return $e;Ut=1,Object.defineProperty($e,"__esModule",{value:!0});const r=Se,e=r.__importDefault(Is()),t=r.__importDefault(Et());class s{constructor(n,{headers:a={},schema:o,fetch:c}={}){this.url=n,this.headers=new Headers(a),this.schemaName=o,this.fetch=c}from(n){const a=new URL(`${this.url}/${n}`);return new e.default(a,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(n){return new s(this.url,{headers:this.headers,schema:n,fetch:this.fetch})}rpc(n,a={},{head:o=!1,get:c=!1,count:l}={}){var d;let h;const u=new URL(`${this.url}/rpc/${n}`);let f;o||c?(h=o?"HEAD":"GET",Object.entries(a).filter(([g,v])=>v!==void 0).map(([g,v])=>[g,Array.isArray(v)?`{${v.join(",")}}`:`${v}`]).forEach(([g,v])=>{u.searchParams.append(g,v)})):(h="POST",f=a);const p=new Headers(this.headers);return l&&p.set("Prefer",`count=${l}`),new t.default({method:h,url:u,headers:p,schema:this.schemaName,body:f,fetch:(d=this.fetch)!==null&&d!==void 0?d:fetch})}}return $e.default=s,$e}Object.defineProperty(F,"__esModule",{value:!0});var xs=F.PostgrestError=Fs=F.PostgrestBuilder=zs=F.PostgrestTransformBuilder=Ds=F.PostgrestFilterBuilder=Us=F.PostgrestQueryBuilder=Ns=F.PostgrestClient=void 0;const ke=Se,$s=ke.__importDefault(Sr());var Ns=F.PostgrestClient=$s.default;const Ls=ke.__importDefault(Is());var Us=F.PostgrestQueryBuilder=Ls.default;const qs=ke.__importDefault(Et());var Ds=F.PostgrestFilterBuilder=qs.default;const Bs=ke.__importDefault(Ps());var zs=F.PostgrestTransformBuilder=Bs.default;const Ms=ke.__importDefault(Rs());var Fs=F.PostgrestBuilder=Ms.default;const Vs=ke.__importDefault(As());xs=F.PostgrestError=Vs.default;var Hs=F.default={PostgrestClient:$s.default,PostgrestQueryBuilder:Ls.default,PostgrestFilterBuilder:qs.default,PostgrestTransformBuilder:Bs.default,PostgrestBuilder:Ms.default,PostgrestError:Vs.default};const kr=pr({__proto__:null,get PostgrestBuilder(){return Fs},get PostgrestClient(){return Ns},get PostgrestError(){return xs},get PostgrestFilterBuilder(){return Ds},get PostgrestQueryBuilder(){return Us},get PostgrestTransformBuilder(){return zs},default:Hs},[F]),{PostgrestClient:Cr,PostgrestQueryBuilder:sa,PostgrestFilterBuilder:ra,PostgrestTransformBuilder:ia,PostgrestBuilder:na,PostgrestError:aa}=Hs||kr;class Or{static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"){const t=process.versions;if(t&&t.node){const s=t.node,i=parseInt(s.replace(/^v/,"").split(".")[0]);return i>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${i} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${i} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const s=this.getWebSocketConstructor();return new s(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const jr="2.81.1",Tr=`realtime-js/${jr}`,Ws="1.0.0",Ar="2.0.0",qt=Ws,dt=1e4,Rr=1e3,Pr=100;var oe;(function(r){r[r.connecting=0]="connecting",r[r.open=1]="open",r[r.closing=2]="closing",r[r.closed=3]="closed"})(oe||(oe={}));var q;(function(r){r.closed="closed",r.errored="errored",r.joined="joined",r.joining="joining",r.leaving="leaving"})(q||(q={}));var K;(function(r){r.close="phx_close",r.error="phx_error",r.join="phx_join",r.reply="phx_reply",r.leave="phx_leave",r.access_token="access_token"})(K||(K={}));var ut;(function(r){r.websocket="websocket"})(ut||(ut={}));var ce;(function(r){r.Connecting="connecting",r.Open="open",r.Closing="closing",r.Closed="closed"})(ce||(ce={}));class Ir{constructor(){this.HEADER_LENGTH=1,this.META_LENGTH=4,this.USER_BROADCAST_PUSH_META_LENGTH=5,this.KINDS={push:0,reply:1,broadcast:2,userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST="broadcast"}encode(e,t){if(this._isArrayBuffer(e.payload))return t(this._binaryEncodePush(e));if(e.event===this.BROADCAST&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let s=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(s))}_binaryEncodePush(e){const{join_ref:t,ref:s,event:i,topic:n,payload:a}=e,o=this.META_LENGTH+t.length+s.length+n.length+i.length,c=new ArrayBuffer(this.HEADER_LENGTH+o);let l=new DataView(c),d=0;l.setUint8(d++,this.KINDS.push),l.setUint8(d++,t.length),l.setUint8(d++,s.length),l.setUint8(d++,n.length),l.setUint8(d++,i.length),Array.from(t,u=>l.setUint8(d++,u.charCodeAt(0))),Array.from(s,u=>l.setUint8(d++,u.charCodeAt(0))),Array.from(n,u=>l.setUint8(d++,u.charCodeAt(0))),Array.from(i,u=>l.setUint8(d++,u.charCodeAt(0)));var h=new Uint8Array(c.byteLength+a.byteLength);return h.set(new Uint8Array(c),0),h.set(new Uint8Array(a),c.byteLength),h.buffer}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,s;const{join_ref:i,ref:n,topic:a}=e,o=e.payload.event,c=(s=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&s!==void 0?s:new ArrayBuffer(0),l=this.USER_BROADCAST_PUSH_META_LENGTH+i.length+n.length+a.length+o.length,d=new ArrayBuffer(this.HEADER_LENGTH+l);let h=new DataView(d),u=0;h.setUint8(u++,this.KINDS.userBroadcastPush),h.setUint8(u++,i.length),h.setUint8(u++,n.length),h.setUint8(u++,a.length),h.setUint8(u++,o.length),h.setUint8(u++,this.BINARY_ENCODING),Array.from(i,p=>h.setUint8(u++,p.charCodeAt(0))),Array.from(n,p=>h.setUint8(u++,p.charCodeAt(0))),Array.from(a,p=>h.setUint8(u++,p.charCodeAt(0))),Array.from(o,p=>h.setUint8(u++,p.charCodeAt(0)));var f=new Uint8Array(d.byteLength+c.byteLength);return f.set(new Uint8Array(d),0),f.set(new Uint8Array(c),d.byteLength),f.buffer}_encodeJsonUserBroadcastPush(e){var t,s;const{join_ref:i,ref:n,topic:a}=e,o=e.payload.event,c=(s=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&s!==void 0?s:{},d=new TextEncoder().encode(JSON.stringify(c)).buffer,h=this.USER_BROADCAST_PUSH_META_LENGTH+i.length+n.length+a.length+o.length,u=new ArrayBuffer(this.HEADER_LENGTH+h);let f=new DataView(u),p=0;f.setUint8(p++,this.KINDS.userBroadcastPush),f.setUint8(p++,i.length),f.setUint8(p++,n.length),f.setUint8(p++,a.length),f.setUint8(p++,o.length),f.setUint8(p++,this.JSON_ENCODING),Array.from(i,v=>f.setUint8(p++,v.charCodeAt(0))),Array.from(n,v=>f.setUint8(p++,v.charCodeAt(0))),Array.from(a,v=>f.setUint8(p++,v.charCodeAt(0))),Array.from(o,v=>f.setUint8(p++,v.charCodeAt(0)));var g=new Uint8Array(u.byteLength+d.byteLength);return g.set(new Uint8Array(u),0),g.set(new Uint8Array(d),u.byteLength),g.buffer}decode(e,t){if(this._isArrayBuffer(e)){let s=this._binaryDecode(e);return t(s)}if(typeof e=="string"){const s=JSON.parse(e),[i,n,a,o,c]=s;return t({join_ref:i,ref:n,topic:a,event:o,payload:c})}return t({})}_binaryDecode(e){const t=new DataView(e),s=t.getUint8(0),i=new TextDecoder;switch(s){case this.KINDS.push:return this._decodePush(e,t,i);case this.KINDS.reply:return this._decodeReply(e,t,i);case this.KINDS.broadcast:return this._decodeBroadcast(e,t,i);case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,t,i)}}_decodePush(e,t,s){const i=t.getUint8(1),n=t.getUint8(2),a=t.getUint8(3);let o=this.HEADER_LENGTH+this.META_LENGTH-1;const c=s.decode(e.slice(o,o+i));o=o+i;const l=s.decode(e.slice(o,o+n));o=o+n;const d=s.decode(e.slice(o,o+a));o=o+a;const h=JSON.parse(s.decode(e.slice(o,e.byteLength)));return{join_ref:c,ref:null,topic:l,event:d,payload:h}}_decodeReply(e,t,s){const i=t.getUint8(1),n=t.getUint8(2),a=t.getUint8(3),o=t.getUint8(4);let c=this.HEADER_LENGTH+this.META_LENGTH;const l=s.decode(e.slice(c,c+i));c=c+i;const d=s.decode(e.slice(c,c+n));c=c+n;const h=s.decode(e.slice(c,c+a));c=c+a;const u=s.decode(e.slice(c,c+o));c=c+o;const f=JSON.parse(s.decode(e.slice(c,e.byteLength))),p={status:u,response:f};return{join_ref:l,ref:d,topic:h,event:K.reply,payload:p}}_decodeBroadcast(e,t,s){const i=t.getUint8(1),n=t.getUint8(2);let a=this.HEADER_LENGTH+2;const o=s.decode(e.slice(a,a+i));a=a+i;const c=s.decode(e.slice(a,a+n));a=a+n;const l=JSON.parse(s.decode(e.slice(a,e.byteLength)));return{join_ref:null,ref:null,topic:o,event:c,payload:l}}_decodeUserBroadcast(e,t,s){const i=t.getUint8(1),n=t.getUint8(2),a=t.getUint8(3),o=t.getUint8(4);let c=this.HEADER_LENGTH+4;const l=s.decode(e.slice(c,c+i));c=c+i;const d=s.decode(e.slice(c,c+n));c=c+n;const h=s.decode(e.slice(c,c+a));c=c+a;const u=e.slice(c,e.byteLength),f=o===this.JSON_ENCODING?JSON.parse(s.decode(u)):u,p={type:this.BROADCAST,event:d,payload:f};return a>0&&(p.meta=JSON.parse(h)),{join_ref:null,ref:null,topic:l,event:this.BROADCAST,payload:p}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e==null?void 0:e.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}}class Ks{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var I;(function(r){r.abstime="abstime",r.bool="bool",r.date="date",r.daterange="daterange",r.float4="float4",r.float8="float8",r.int2="int2",r.int4="int4",r.int4range="int4range",r.int8="int8",r.int8range="int8range",r.json="json",r.jsonb="jsonb",r.money="money",r.numeric="numeric",r.oid="oid",r.reltime="reltime",r.text="text",r.time="time",r.timestamp="timestamp",r.timestamptz="timestamptz",r.timetz="timetz",r.tsrange="tsrange",r.tstzrange="tstzrange"})(I||(I={}));const Dt=(r,e,t={})=>{var s;const i=(s=t.skipTypes)!==null&&s!==void 0?s:[];return e?Object.keys(e).reduce((n,a)=>(n[a]=xr(a,r,e,i),n),{}):{}},xr=(r,e,t,s)=>{const i=e.find(o=>o.name===r),n=i==null?void 0:i.type,a=t[r];return n&&!s.includes(n)?Js(n,a):ht(a)},Js=(r,e)=>{if(r.charAt(0)==="_"){const t=r.slice(1,r.length);return Ur(e,t)}switch(r){case I.bool:return $r(e);case I.float4:case I.float8:case I.int2:case I.int4:case I.int8:case I.numeric:case I.oid:return Nr(e);case I.json:case I.jsonb:return Lr(e);case I.timestamp:return qr(e);case I.abstime:case I.date:case I.daterange:case I.int4range:case I.int8range:case I.money:case I.reltime:case I.text:case I.time:case I.timestamptz:case I.timetz:case I.tsrange:case I.tstzrange:return ht(e);default:return ht(e)}},ht=r=>r,$r=r=>{switch(r){case"t":return!0;case"f":return!1;default:return r}},Nr=r=>{if(typeof r=="string"){const e=parseFloat(r);if(!Number.isNaN(e))return e}return r},Lr=r=>{if(typeof r=="string")try{return JSON.parse(r)}catch(e){return console.log(`JSON parse error: ${e}`),r}return r},Ur=(r,e)=>{if(typeof r!="string")return r;const t=r.length-1,s=r[t];if(r[0]==="{"&&s==="}"){let n;const a=r.slice(1,t);try{n=JSON.parse("["+a+"]")}catch{n=a?a.split(","):[]}return n.map(o=>Js(e,o))}return r},qr=r=>typeof r=="string"?r.replace(" ","T"):r,Gs=r=>{const e=new URL(r);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class Xe{constructor(e,t,s={},i=dt){this.channel=e,this.event=t,this.payload=s,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(s=>s.status===e).forEach(s=>s.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Bt;(function(r){r.SYNC="sync",r.JOIN="join",r.LEAVE="leave"})(Bt||(Bt={}));class Te{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},i=>{const{onJoin:n,onLeave:a,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Te.syncState(this.state,i,n,a),this.pendingDiffs.forEach(c=>{this.state=Te.syncDiff(this.state,c,n,a)}),this.pendingDiffs=[],o()}),this.channel._on(s.diff,{},i=>{const{onJoin:n,onLeave:a,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=Te.syncDiff(this.state,i,n,a),o())}),this.onJoin((i,n,a)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:n,newPresences:a})}),this.onLeave((i,n,a)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:n,leftPresences:a})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,s,i){const n=this.cloneDeep(e),a=this.transformState(t),o={},c={};return this.map(n,(l,d)=>{a[l]||(c[l]=d)}),this.map(a,(l,d)=>{const h=n[l];if(h){const u=d.map(v=>v.presence_ref),f=h.map(v=>v.presence_ref),p=d.filter(v=>f.indexOf(v.presence_ref)<0),g=h.filter(v=>u.indexOf(v.presence_ref)<0);p.length>0&&(o[l]=p),g.length>0&&(c[l]=g)}else o[l]=d}),this.syncDiff(n,{joins:o,leaves:c},s,i)}static syncDiff(e,t,s,i){const{joins:n,leaves:a}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),i||(i=()=>{}),this.map(n,(o,c)=>{var l;const d=(l=e[o])!==null&&l!==void 0?l:[];if(e[o]=this.cloneDeep(c),d.length>0){const h=e[o].map(f=>f.presence_ref),u=d.filter(f=>h.indexOf(f.presence_ref)<0);e[o].unshift(...u)}s(o,d,c)}),this.map(a,(o,c)=>{let l=e[o];if(!l)return;const d=c.map(h=>h.presence_ref);l=l.filter(h=>d.indexOf(h.presence_ref)<0),e[o]=l,i(o,l,c),l.length===0&&delete e[o]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,s)=>{const i=e[s];return"metas"in i?t[s]=i.metas.map(n=>(n.presence_ref=n.phx_ref,delete n.phx_ref,delete n.phx_ref_prev,n)):t[s]=i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var zt;(function(r){r.ALL="*",r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(zt||(zt={}));var Ae;(function(r){r.BROADCAST="broadcast",r.PRESENCE="presence",r.POSTGRES_CHANGES="postgres_changes",r.SYSTEM="system"})(Ae||(Ae={}));var X;(function(r){r.SUBSCRIBED="SUBSCRIBED",r.TIMED_OUT="TIMED_OUT",r.CLOSED="CLOSED",r.CHANNEL_ERROR="CHANNEL_ERROR"})(X||(X={}));class St{constructor(e,t={config:{}},s){var i,n;if(this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=q.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Xe(this,K.join,this.params,this.timeout),this.rejoinTimer=new Ks(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=q.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(a=>a.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=q.closed,this.socket._remove(this)}),this._onError(a=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,a),this.state=q.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=q.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",a=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,a),this.state=q.errored,this.rejoinTimer.scheduleTimeout())}),this._on(K.reply,{},(a,o)=>{this._trigger(this._replyEventName(o),a)}),this.presence=new Te(this),this.broadcastEndpointURL=Gs(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((n=(i=this.params.config)===null||i===void 0?void 0:i.broadcast)===null||n===void 0)&&n.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var s,i,n;if(this.socket.isConnected()||this.socket.connect(),this.state==q.closed){const{config:{broadcast:a,presence:o,private:c}}=this.params,l=(i=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(f=>f.filter))!==null&&i!==void 0?i:[],d=!!this.bindings[Ae.PRESENCE]&&this.bindings[Ae.PRESENCE].length>0||((n=this.params.config.presence)===null||n===void 0?void 0:n.enabled)===!0,h={},u={broadcast:a,presence:Object.assign(Object.assign({},o),{enabled:d}),postgres_changes:l,private:c};this.socket.accessTokenValue&&(h.access_token=this.socket.accessTokenValue),this._onError(f=>e==null?void 0:e(X.CHANNEL_ERROR,f)),this._onClose(()=>e==null?void 0:e(X.CLOSED)),this.updateJoinPayload(Object.assign({config:u},h)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:f})=>{var p;if(this.socket.setAuth(),f===void 0){e==null||e(X.SUBSCRIBED);return}else{const g=this.bindings.postgres_changes,v=(p=g==null?void 0:g.length)!==null&&p!==void 0?p:0,E=[];for(let _=0;_<v;_++){const m=g[_],{filter:{event:b,schema:T,table:A,filter:P}}=m,D=f&&f[_];if(D&&D.event===b&&D.schema===T&&D.table===A&&D.filter===P)E.push(Object.assign(Object.assign({},m),{id:D.id}));else{this.unsubscribe(),this.state=q.errored,e==null||e(X.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=E,e&&e(X.SUBSCRIBED);return}}).receive("error",f=>{this.state=q.errored,e==null||e(X.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(f).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(X.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,s){return this.state===q.joined&&e===Ae.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(e,t,s)}async httpSend(e,t,s={}){var i;const n=this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"";if(t==null)return Promise.reject("Payload is required for httpSend()");const a={method:"POST",headers:{Authorization:n,apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},o=await this._fetchWithTimeout(this.broadcastEndpointURL,a,(i=s.timeout)!==null&&i!==void 0?i:this.timeout);if(o.status===202)return{success:!0};let c=o.statusText;try{const l=await o.json();c=l.error||l.message||c}catch{}return Promise.reject(new Error(c))}async send(e,t={}){var s,i;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:n,payload:a}=e,c={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:n,payload:a,private:this.private}]})};try{const l=await this._fetchWithTimeout(this.broadcastEndpointURL,c,(s=t.timeout)!==null&&s!==void 0?s:this.timeout);return await((i=l.body)===null||i===void 0?void 0:i.cancel()),l.ok?"ok":"error"}catch(l){return l.name==="AbortError"?"timed out":"error"}}else return new Promise(n=>{var a,o,c;const l=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((c=(o=(a=this.params)===null||a===void 0?void 0:a.config)===null||o===void 0?void 0:o.broadcast)===null||c===void 0)&&c.ack)&&n("ok"),l.receive("ok",()=>n("ok")),l.receive("error",()=>n("error")),l.receive("timeout",()=>n("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=q.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(K.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(i=>{s=new Xe(this,K.leave,{},e),s.receive("ok",()=>{t(),i("ok")}).receive("timeout",()=>{t(),i("timed out")}).receive("error",()=>{i("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{s==null||s.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=q.closed,this.bindings={}}async _fetchWithTimeout(e,t,s){const i=new AbortController,n=setTimeout(()=>i.abort(),s),a=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(n),a}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new Xe(this,e,t,s);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>Pr){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var i,n;const a=e.toLocaleLowerCase(),{close:o,error:c,leave:l,join:d}=K;if(s&&[o,c,l,d].indexOf(a)>=0&&s!==this._joinRef())return;let u=this._onMessage(a,t,s);if(t&&!u)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(a)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(f=>{var p,g,v;return((p=f.filter)===null||p===void 0?void 0:p.event)==="*"||((v=(g=f.filter)===null||g===void 0?void 0:g.event)===null||v===void 0?void 0:v.toLocaleLowerCase())===a}).map(f=>f.callback(u,s)):(n=this.bindings[a])===null||n===void 0||n.filter(f=>{var p,g,v,E,_,m;if(["broadcast","presence","postgres_changes"].includes(a))if("id"in f){const b=f.id,T=(p=f.filter)===null||p===void 0?void 0:p.event;return b&&((g=t.ids)===null||g===void 0?void 0:g.includes(b))&&(T==="*"||(T==null?void 0:T.toLocaleLowerCase())===((v=t.data)===null||v===void 0?void 0:v.type.toLocaleLowerCase()))}else{const b=(_=(E=f==null?void 0:f.filter)===null||E===void 0?void 0:E.event)===null||_===void 0?void 0:_.toLocaleLowerCase();return b==="*"||b===((m=t==null?void 0:t.event)===null||m===void 0?void 0:m.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===a}).map(f=>{if(typeof u=="object"&&"ids"in u){const p=u.data,{schema:g,table:v,commit_timestamp:E,type:_,errors:m}=p;u=Object.assign(Object.assign({},{schema:g,table:v,commit_timestamp:E,eventType:_,new:{},old:{},errors:m}),this._getPayloadRecords(p))}f.callback(u,s)})}_isClosed(){return this.state===q.closed}_isJoined(){return this.state===q.joined}_isJoining(){return this.state===q.joining}_isLeaving(){return this.state===q.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,s){const i=e.toLocaleLowerCase(),n={type:i,filter:t,callback:s};return this.bindings[i]?this.bindings[i].push(n):this.bindings[i]=[n],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(i=>{var n;return!(((n=i.type)===null||n===void 0?void 0:n.toLocaleLowerCase())===s&&St.isEqual(i.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(K.close,{},e)}_onError(e){this._on(K.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=q.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=Dt(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=Dt(e.columns,e.old_record)),t}}const Ze=()=>{},Be={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Dr=[1e3,2e3,5e3,1e4],Br=1e4,zr=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Mr{constructor(e,t){var s;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=dt,this.transport=null,this.heartbeatIntervalMs=Be.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Ze,this.ref=0,this.reconnectTimer=null,this.vsn=qt,this.logger=Ze,this.conn=null,this.sendBuffer=[],this.serializer=new Ir,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=i=>i?(...n)=>i(...n):(...n)=>fetch(...n),!(!((s=t==null?void 0:t.params)===null||s===void 0)&&s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${ut.websocket}`,this.httpEndpoint=Gs(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t==null?void 0:t.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Or.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case oe.connecting:return ce.Connecting;case oe.open:return ce.Open;case oe.closing:return ce.Closing;default:return ce.Closed}}isConnected(){return this.connectionState()===ce.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const s=`realtime:${e}`,i=this.getChannels().find(n=>n.topic===s);if(i)return i;{const n=new St(`realtime:${e}`,t,this);return this.channels.push(n),n}}push(e){const{topic:t,event:s,payload:i,ref:n}=e,a=()=>{this.encode(e,o=>{var c;(c=this.conn)===null||c===void 0||c.send(o)})};this.log("push",`${t} ${s} (${n})`,i),this.isConnected()?a():this.sendBuffer.push(a)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Rr,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},Be.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(s=>s.topic===e&&(s._isJoined()||s._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply")try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error")}catch(l){this.log("error","error in heartbeat callback",l)}t.ref&&t.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:s,event:i,payload:n,ref:a}=t,o=a?`(${a})`:"",c=n.status||"";this.log("receive",`${c} ${s} ${i} ${o}`.trim(),n),this.channels.filter(l=>l._isMember(s)).forEach(l=>l._trigger(i,n,a)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){if(this.conn){if(this.conn.readyState===oe.open||this.conn.readyState===oe.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(K.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const s=e.match(/\?/)?"&":"?",i=new URLSearchParams(t);return`${e}${s}${i}`}_workerObjectUrl(e){let t;if(e)t=e;else{const s=new Blob([zr],{type:"application/javascript"});t=URL.createObjectURL(s)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t;e?t=e:this.accessToken?t=await this.accessToken():t=this.accessTokenValue,this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(s=>{const i={access_token:t,version:Tr};t&&s.updateJoinPayload(i),s.joinedOnce&&s._isJoined()&&s._push(K.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this.setAuth().catch(t=>{this.log("error",`error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(s=>{try{s(t)}catch(i){this.log("error",`error in ${e} callback`,i)}})}catch(s){this.log("error",`error triggering ${e} callbacks`,s)}}_setupReconnectionTimer(){this.reconnectTimer=new Ks(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Be.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,s,i,n,a,o,c,l,d,h,u,f;switch(this.transport=(t=e==null?void 0:e.transport)!==null&&t!==void 0?t:null,this.timeout=(s=e==null?void 0:e.timeout)!==null&&s!==void 0?s:dt,this.heartbeatIntervalMs=(i=e==null?void 0:e.heartbeatIntervalMs)!==null&&i!==void 0?i:Be.HEARTBEAT_INTERVAL,this.worker=(n=e==null?void 0:e.worker)!==null&&n!==void 0?n:!1,this.accessToken=(a=e==null?void 0:e.accessToken)!==null&&a!==void 0?a:null,this.heartbeatCallback=(o=e==null?void 0:e.heartbeatCallback)!==null&&o!==void 0?o:Ze,this.vsn=(c=e==null?void 0:e.vsn)!==null&&c!==void 0?c:qt,e!=null&&e.params&&(this.params=e.params),e!=null&&e.logger&&(this.logger=e.logger),(e!=null&&e.logLevel||e!=null&&e.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(l=e==null?void 0:e.reconnectAfterMs)!==null&&l!==void 0?l:p=>Dr[p-1]||Br,this.vsn){case Ws:this.encode=(d=e==null?void 0:e.encode)!==null&&d!==void 0?d:(p,g)=>g(JSON.stringify(p)),this.decode=(h=e==null?void 0:e.decode)!==null&&h!==void 0?h:(p,g)=>g(JSON.parse(p));break;case Ar:this.encode=(u=e==null?void 0:e.encode)!==null&&u!==void 0?u:this.serializer.encode.bind(this.serializer),this.decode=(f=e==null?void 0:e.decode)!==null&&f!==void 0?f:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e==null?void 0:e.workerUrl}}}class kt extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function x(r){return typeof r=="object"&&r!==null&&"__isStorageError"in r}class Fr extends kt{constructor(e,t,s){super(e),this.name="StorageApiError",this.status=t,this.statusCode=s}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class ft extends kt{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}const Ct=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),Vr=()=>Response,pt=r=>{if(Array.isArray(r))return r.map(t=>pt(t));if(typeof r=="function"||r!==Object(r))return r;const e={};return Object.entries(r).forEach(([t,s])=>{const i=t.replace(/([-_][a-z])/gi,n=>n.toUpperCase().replace(/[-_]/g,""));e[i]=pt(s)}),e},Hr=r=>{if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},et=r=>{var e;return r.msg||r.message||r.error_description||(typeof r.error=="string"?r.error:(e=r.error)===null||e===void 0?void 0:e.message)||JSON.stringify(r)},Wr=(r,e,t)=>S(void 0,void 0,void 0,function*(){const s=yield Vr();r instanceof s&&!(t!=null&&t.noResolveJson)?r.json().then(i=>{const n=r.status||500,a=(i==null?void 0:i.statusCode)||n+"";e(new Fr(et(i),n,a))}).catch(i=>{e(new ft(et(i),i))}):e(new ft(et(r),r))}),Kr=(r,e,t,s)=>{const i={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"||!s?i:(Hr(s)?(i.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(s)):i.body=s,e!=null&&e.duplex&&(i.duplex=e.duplex),Object.assign(Object.assign({},i),t))};function xe(r,e,t,s,i,n){return S(this,void 0,void 0,function*(){return new Promise((a,o)=>{r(t,Kr(e,s,i,n)).then(c=>{if(!c.ok)throw c;return s!=null&&s.noResolveJson?c:c.json()}).then(c=>a(c)).catch(c=>Wr(c,o,s))})})}function Re(r,e,t,s){return S(this,void 0,void 0,function*(){return xe(r,"GET",e,t,s)})}function Q(r,e,t,s,i){return S(this,void 0,void 0,function*(){return xe(r,"POST",e,s,i,t)})}function mt(r,e,t,s,i){return S(this,void 0,void 0,function*(){return xe(r,"PUT",e,s,i,t)})}function Jr(r,e,t,s){return S(this,void 0,void 0,function*(){return xe(r,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),s)})}function Ot(r,e,t,s,i){return S(this,void 0,void 0,function*(){return xe(r,"DELETE",e,s,i,t)})}class Gr{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t}then(e,t){return this.execute().then(e,t)}execute(){return S(this,void 0,void 0,function*(){try{return{data:(yield this.downloadFn()).body,error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(x(e))return{data:null,error:e};throw e}})}}var Ys;class Yr{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t,this[Ys]="BlobDownloadBuilder",this.promise=null}asStream(){return new Gr(this.downloadFn,this.shouldThrowOnError)}then(e,t){return this.getPromise().then(e,t)}catch(e){return this.getPromise().catch(e)}finally(e){return this.getPromise().finally(e)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}execute(){return S(this,void 0,void 0,function*(){try{return{data:yield(yield this.downloadFn()).blob(),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(x(e))return{data:null,error:e};throw e}})}}Ys=Symbol.toStringTag;const Qr={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Mt={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class Xr{constructor(e,t={},s,i){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.bucketId=s,this.fetch=Ct(i)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(e,t,s,i){return S(this,void 0,void 0,function*(){try{let n;const a=Object.assign(Object.assign({},Mt),i);let o=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(a.upsert)});const c=a.metadata;typeof Blob<"u"&&s instanceof Blob?(n=new FormData,n.append("cacheControl",a.cacheControl),c&&n.append("metadata",this.encodeMetadata(c)),n.append("",s)):typeof FormData<"u"&&s instanceof FormData?(n=s,n.has("cacheControl")||n.append("cacheControl",a.cacheControl),c&&!n.has("metadata")&&n.append("metadata",this.encodeMetadata(c))):(n=s,o["cache-control"]=`max-age=${a.cacheControl}`,o["content-type"]=a.contentType,c&&(o["x-metadata"]=this.toBase64(this.encodeMetadata(c))),(typeof ReadableStream<"u"&&n instanceof ReadableStream||n&&typeof n=="object"&&"pipe"in n&&typeof n.pipe=="function")&&!a.duplex&&(a.duplex="half")),i!=null&&i.headers&&(o=Object.assign(Object.assign({},o),i.headers));const l=this._removeEmptyFolders(t),d=this._getFinalPath(l),h=yield(e=="PUT"?mt:Q)(this.fetch,`${this.url}/object/${d}`,n,Object.assign({headers:o},a!=null&&a.duplex?{duplex:a.duplex}:{}));return{data:{path:l,id:h.Id,fullPath:h.Key},error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(x(n))return{data:null,error:n};throw n}})}upload(e,t,s){return S(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,s)})}uploadToSignedUrl(e,t,s,i){return S(this,void 0,void 0,function*(){const n=this._removeEmptyFolders(e),a=this._getFinalPath(n),o=new URL(this.url+`/object/upload/sign/${a}`);o.searchParams.set("token",t);try{let c;const l=Object.assign({upsert:Mt.upsert},i),d=Object.assign(Object.assign({},this.headers),{"x-upsert":String(l.upsert)});typeof Blob<"u"&&s instanceof Blob?(c=new FormData,c.append("cacheControl",l.cacheControl),c.append("",s)):typeof FormData<"u"&&s instanceof FormData?(c=s,c.append("cacheControl",l.cacheControl)):(c=s,d["cache-control"]=`max-age=${l.cacheControl}`,d["content-type"]=l.contentType);const h=yield mt(this.fetch,o.toString(),c,{headers:d});return{data:{path:n,fullPath:h.Key},error:null}}catch(c){if(this.shouldThrowOnError)throw c;if(x(c))return{data:null,error:c};throw c}})}createSignedUploadUrl(e,t){return S(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e);const i=Object.assign({},this.headers);t!=null&&t.upsert&&(i["x-upsert"]="true");const n=yield Q(this.fetch,`${this.url}/object/upload/sign/${s}`,{},{headers:i}),a=new URL(this.url+n.url),o=a.searchParams.get("token");if(!o)throw new kt("No token returned by API");return{data:{signedUrl:a.toString(),path:e,token:o},error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(x(s))return{data:null,error:s};throw s}})}update(e,t,s){return S(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,s)})}move(e,t,s){return S(this,void 0,void 0,function*(){try{return{data:yield Q(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers}),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(x(i))return{data:null,error:i};throw i}})}copy(e,t,s){return S(this,void 0,void 0,function*(){try{return{data:{path:(yield Q(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers})).Key},error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(x(i))return{data:null,error:i};throw i}})}createSignedUrl(e,t,s){return S(this,void 0,void 0,function*(){try{let i=this._getFinalPath(e),n=yield Q(this.fetch,`${this.url}/object/sign/${i}`,Object.assign({expiresIn:t},s!=null&&s.transform?{transform:s.transform}:{}),{headers:this.headers});const a=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return n={signedUrl:encodeURI(`${this.url}${n.signedURL}${a}`)},{data:n,error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(x(i))return{data:null,error:i};throw i}})}createSignedUrls(e,t,s){return S(this,void 0,void 0,function*(){try{const i=yield Q(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),n=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return{data:i.map(a=>Object.assign(Object.assign({},a),{signedUrl:a.signedURL?encodeURI(`${this.url}${a.signedURL}${n}`):null})),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(x(i))return{data:null,error:i};throw i}})}download(e,t){const i=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",n=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),a=n?`?${n}`:"",o=this._getFinalPath(e),c=()=>Re(this.fetch,`${this.url}/${i}/${o}${a}`,{headers:this.headers,noResolveJson:!0});return new Yr(c,this.shouldThrowOnError)}info(e){return S(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const s=yield Re(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:pt(s),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(x(s))return{data:null,error:s};throw s}})}exists(e){return S(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield Jr(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(x(s)&&s instanceof ft){const i=s.originalError;if([400,404].includes(i==null?void 0:i.status))return{data:!1,error:s}}throw s}})}getPublicUrl(e,t){const s=this._getFinalPath(e),i=[],n=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";n!==""&&i.push(n);const o=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",c=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});c!==""&&i.push(c);let l=i.join("&");return l!==""&&(l=`?${l}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${s}${l}`)}}}remove(e){return S(this,void 0,void 0,function*(){try{return{data:yield Ot(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}list(e,t,s){return S(this,void 0,void 0,function*(){try{const i=Object.assign(Object.assign(Object.assign({},Qr),t),{prefix:e||""});return{data:yield Q(this.fetch,`${this.url}/object/list/${this.bucketId}`,i,{headers:this.headers},s),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(x(i))return{data:null,error:i};throw i}})}listV2(e,t){return S(this,void 0,void 0,function*(){try{const s=Object.assign({},e);return{data:yield Q(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,s,{headers:this.headers},t),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(x(s))return{data:null,error:s};throw s}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const Qs="2.81.1",Xs={"X-Client-Info":`storage-js/${Qs}`};class Zr{constructor(e,t={},s,i){this.shouldThrowOnError=!1;const n=new URL(e);i!=null&&i.useNewHostname&&/supabase\.(co|in|red)$/.test(n.hostname)&&!n.hostname.includes("storage.supabase.")&&(n.hostname=n.hostname.replace("supabase.","storage.supabase.")),this.url=n.href.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},Xs),t),this.fetch=Ct(s)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(e){return S(this,void 0,void 0,function*(){try{const t=this.listBucketOptionsToQueryString(e);return{data:yield Re(this.fetch,`${this.url}/bucket${t}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}getBucket(e){return S(this,void 0,void 0,function*(){try{return{data:yield Re(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}createBucket(e){return S(this,arguments,void 0,function*(t,s={public:!1}){try{return{data:yield Q(this.fetch,`${this.url}/bucket`,{id:t,name:t,type:s.type,public:s.public,file_size_limit:s.fileSizeLimit,allowed_mime_types:s.allowedMimeTypes},{headers:this.headers}),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(x(i))return{data:null,error:i};throw i}})}updateBucket(e,t){return S(this,void 0,void 0,function*(){try{return{data:yield mt(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(x(s))return{data:null,error:s};throw s}})}emptyBucket(e){return S(this,void 0,void 0,function*(){try{return{data:yield Q(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}deleteBucket(e){return S(this,void 0,void 0,function*(){try{return{data:yield Ot(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}listBucketOptionsToQueryString(e){const t={};return e&&("limit"in e&&(t.limit=String(e.limit)),"offset"in e&&(t.offset=String(e.offset)),e.search&&(t.search=e.search),e.sortColumn&&(t.sortColumn=e.sortColumn),e.sortOrder&&(t.sortOrder=e.sortOrder)),Object.keys(t).length>0?"?"+new URLSearchParams(t).toString():""}}class ei{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},Xs),t),this.fetch=Ct(s)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return S(this,void 0,void 0,function*(){try{return{data:yield Q(this.fetch,`${this.url}/bucket`,{name:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}listBuckets(e){return S(this,void 0,void 0,function*(){try{const t=new URLSearchParams;(e==null?void 0:e.limit)!==void 0&&t.set("limit",e.limit.toString()),(e==null?void 0:e.offset)!==void 0&&t.set("offset",e.offset.toString()),e!=null&&e.sortColumn&&t.set("sortColumn",e.sortColumn),e!=null&&e.sortOrder&&t.set("sortOrder",e.sortOrder),e!=null&&e.search&&t.set("search",e.search);const s=t.toString(),i=s?`${this.url}/bucket?${s}`:`${this.url}/bucket`;return{data:yield Re(this.fetch,i,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}deleteBucket(e){return S(this,void 0,void 0,function*(){try{return{data:yield Ot(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(x(t))return{data:null,error:t};throw t}})}}const jt={"X-Client-Info":`storage-js/${Qs}`,"Content-Type":"application/json"};class Zs extends Error{constructor(e){super(e),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}}function H(r){return typeof r=="object"&&r!==null&&"__isStorageVectorsError"in r}class tt extends Zs{constructor(e,t,s){super(e),this.name="StorageVectorsApiError",this.status=t,this.statusCode=s}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class ti extends Zs{constructor(e,t){super(e),this.name="StorageVectorsUnknownError",this.originalError=t}}var Ft;(function(r){r.InternalError="InternalError",r.S3VectorConflictException="S3VectorConflictException",r.S3VectorNotFoundException="S3VectorNotFoundException",r.S3VectorBucketNotEmpty="S3VectorBucketNotEmpty",r.S3VectorMaxBucketsExceeded="S3VectorMaxBucketsExceeded",r.S3VectorMaxIndexesExceeded="S3VectorMaxIndexesExceeded"})(Ft||(Ft={}));const Tt=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),si=r=>{if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},Vt=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),ri=(r,e,t)=>S(void 0,void 0,void 0,function*(){if(r&&typeof r=="object"&&"status"in r&&"ok"in r&&typeof r.status=="number"&&!(t!=null&&t.noResolveJson)){const i=r.status||500,n=r;if(typeof n.json=="function")n.json().then(a=>{const o=(a==null?void 0:a.statusCode)||(a==null?void 0:a.code)||i+"";e(new tt(Vt(a),i,o))}).catch(()=>{const a=i+"",o=n.statusText||`HTTP ${i} error`;e(new tt(o,i,a))});else{const a=i+"",o=n.statusText||`HTTP ${i} error`;e(new tt(o,i,a))}}else e(new ti(Vt(r),r))}),ii=(r,e,t,s)=>{const i={method:r,headers:(e==null?void 0:e.headers)||{}};return s?(si(s)?(i.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(s)):i.body=s,Object.assign(Object.assign({},i),t)):i};function ni(r,e,t,s,i,n){return S(this,void 0,void 0,function*(){return new Promise((a,o)=>{r(t,ii(e,s,i,n)).then(c=>{if(!c.ok)throw c;if(s!=null&&s.noResolveJson)return c;const l=c.headers.get("content-type");return!l||!l.includes("application/json")?{}:c.json()}).then(c=>a(c)).catch(c=>ri(c,o,s))})})}function W(r,e,t,s,i){return S(this,void 0,void 0,function*(){return ni(r,"POST",e,s,i,t)})}class ai{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},jt),t),this.fetch=Tt(s)}throwOnError(){return this.shouldThrowOnError=!0,this}createIndex(e){return S(this,void 0,void 0,function*(){try{return{data:(yield W(this.fetch,`${this.url}/CreateIndex`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}getIndex(e,t){return S(this,void 0,void 0,function*(){try{return{data:yield W(this.fetch,`${this.url}/GetIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(H(s))return{data:null,error:s};throw s}})}listIndexes(e){return S(this,void 0,void 0,function*(){try{return{data:yield W(this.fetch,`${this.url}/ListIndexes`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}deleteIndex(e,t){return S(this,void 0,void 0,function*(){try{return{data:(yield W(this.fetch,`${this.url}/DeleteIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}))||{},error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(H(s))return{data:null,error:s};throw s}})}}class oi{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},jt),t),this.fetch=Tt(s)}throwOnError(){return this.shouldThrowOnError=!0,this}putVectors(e){return S(this,void 0,void 0,function*(){try{if(e.vectors.length<1||e.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:(yield W(this.fetch,`${this.url}/PutVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}getVectors(e){return S(this,void 0,void 0,function*(){try{return{data:yield W(this.fetch,`${this.url}/GetVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}listVectors(e){return S(this,void 0,void 0,function*(){try{if(e.segmentCount!==void 0){if(e.segmentCount<1||e.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(e.segmentIndex!==void 0&&(e.segmentIndex<0||e.segmentIndex>=e.segmentCount))throw new Error(`segmentIndex must be between 0 and ${e.segmentCount-1}`)}return{data:yield W(this.fetch,`${this.url}/ListVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}queryVectors(e){return S(this,void 0,void 0,function*(){try{return{data:yield W(this.fetch,`${this.url}/QueryVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}deleteVectors(e){return S(this,void 0,void 0,function*(){try{if(e.keys.length<1||e.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:(yield W(this.fetch,`${this.url}/DeleteVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}}class ci{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},jt),t),this.fetch=Tt(s)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return S(this,void 0,void 0,function*(){try{return{data:(yield W(this.fetch,`${this.url}/CreateVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}getBucket(e){return S(this,void 0,void 0,function*(){try{return{data:yield W(this.fetch,`${this.url}/GetVectorBucket`,{vectorBucketName:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}listBuckets(){return S(this,arguments,void 0,function*(e={}){try{return{data:yield W(this.fetch,`${this.url}/ListVectorBuckets`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}deleteBucket(e){return S(this,void 0,void 0,function*(){try{return{data:(yield W(this.fetch,`${this.url}/DeleteVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(H(t))return{data:null,error:t};throw t}})}}class li extends ci{constructor(e,t={}){super(e,t.headers||{},t.fetch)}from(e){return new di(this.url,this.headers,e,this.fetch)}}class di extends ai{constructor(e,t,s,i){super(e,t,i),this.vectorBucketName=s}createIndex(e){const t=Object.create(null,{createIndex:{get:()=>super.createIndex}});return S(this,void 0,void 0,function*(){return t.createIndex.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName}))})}listIndexes(){const e=Object.create(null,{listIndexes:{get:()=>super.listIndexes}});return S(this,arguments,void 0,function*(t={}){return e.listIndexes.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName}))})}getIndex(e){const t=Object.create(null,{getIndex:{get:()=>super.getIndex}});return S(this,void 0,void 0,function*(){return t.getIndex.call(this,this.vectorBucketName,e)})}deleteIndex(e){const t=Object.create(null,{deleteIndex:{get:()=>super.deleteIndex}});return S(this,void 0,void 0,function*(){return t.deleteIndex.call(this,this.vectorBucketName,e)})}index(e){return new ui(this.url,this.headers,this.vectorBucketName,e,this.fetch)}}class ui extends oi{constructor(e,t,s,i,n){super(e,t,n),this.vectorBucketName=s,this.indexName=i}putVectors(e){const t=Object.create(null,{putVectors:{get:()=>super.putVectors}});return S(this,void 0,void 0,function*(){return t.putVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}getVectors(e){const t=Object.create(null,{getVectors:{get:()=>super.getVectors}});return S(this,void 0,void 0,function*(){return t.getVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}listVectors(){const e=Object.create(null,{listVectors:{get:()=>super.listVectors}});return S(this,arguments,void 0,function*(t={}){return e.listVectors.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}queryVectors(e){const t=Object.create(null,{queryVectors:{get:()=>super.queryVectors}});return S(this,void 0,void 0,function*(){return t.queryVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}deleteVectors(e){const t=Object.create(null,{deleteVectors:{get:()=>super.deleteVectors}});return S(this,void 0,void 0,function*(){return t.deleteVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}}class hi extends Zr{constructor(e,t={},s,i){super(e,t,s,i)}from(e){return new Xr(this.url,this.headers,e,this.fetch)}get vectors(){return new li(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new ei(this.url+"/iceberg",this.headers,this.fetch)}}const fi="2.81.1";let je="";typeof Deno<"u"?je="deno":typeof document<"u"?je="web":typeof navigator<"u"&&navigator.product==="ReactNative"?je="react-native":je="node";const pi={"X-Client-Info":`supabase-js-${je}/${fi}`},mi={headers:pi},gi={schema:"public"},vi={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},yi={},bi=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),wi=()=>Headers,_i=(r,e,t)=>{const s=bi(t),i=wi();return async(n,a)=>{var o;const c=(o=await e())!==null&&o!==void 0?o:r;let l=new i(a==null?void 0:a.headers);return l.has("apikey")||l.set("apikey",r),l.has("Authorization")||l.set("Authorization",`Bearer ${c}`),s(n,Object.assign(Object.assign({},a),{headers:l}))}};function Ei(r){return r.endsWith("/")?r:r+"/"}function Si(r,e){var t,s;const{db:i,auth:n,realtime:a,global:o}=r,{db:c,auth:l,realtime:d,global:h}=e,u={db:Object.assign(Object.assign({},c),i),auth:Object.assign(Object.assign({},l),n),realtime:Object.assign(Object.assign({},d),a),storage:{},global:Object.assign(Object.assign(Object.assign({},h),o),{headers:Object.assign(Object.assign({},(t=h==null?void 0:h.headers)!==null&&t!==void 0?t:{}),(s=o==null?void 0:o.headers)!==null&&s!==void 0?s:{})}),accessToken:async()=>""};return r.accessToken?u.accessToken=r.accessToken:delete u.accessToken,u}function ki(r){const e=r==null?void 0:r.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Ei(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}const er="2.81.1",ve=30*1e3,gt=3,st=gt*ve,Ci="http://localhost:9999",Oi="supabase.auth.token",ji={"X-Client-Info":`gotrue-js/${er}`},vt="X-Supabase-Api-Version",tr={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Ti=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Ai=10*60*1e3;class Pe extends Error{constructor(e,t,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=s}}function k(r){return typeof r=="object"&&r!==null&&"__isAuthError"in r}class Ri extends Pe{constructor(e,t,s){super(e,t,s),this.name="AuthApiError",this.status=t,this.code=s}}function Pi(r){return k(r)&&r.name==="AuthApiError"}class le extends Pe{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class re extends Pe{constructor(e,t,s,i){super(e,s,i),this.name=t,this.status=s}}class G extends re{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function Ii(r){return k(r)&&r.name==="AuthSessionMissingError"}class he extends re{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class ze extends re{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Me extends re{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function xi(r){return k(r)&&r.name==="AuthImplicitGrantRedirectError"}class Ht extends re{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class yt extends re{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function rt(r){return k(r)&&r.name==="AuthRetryableFetchError"}class Wt extends re{constructor(e,t,s){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=s}}class bt extends re{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const We="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Kt=` 	
\r=`.split(""),$i=(()=>{const r=new Array(128);for(let e=0;e<r.length;e+=1)r[e]=-1;for(let e=0;e<Kt.length;e+=1)r[Kt[e].charCodeAt(0)]=-2;for(let e=0;e<We.length;e+=1)r[We[e].charCodeAt(0)]=e;return r})();function Jt(r,e,t){if(r!==null)for(e.queue=e.queue<<8|r,e.queuedBits+=8;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;t(We[s]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;t(We[s]),e.queuedBits-=6}}function sr(r,e,t){const s=$i[r];if(s>-1)for(e.queue=e.queue<<6|s,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(r)}"`)}}function Gt(r){const e=[],t=a=>{e.push(String.fromCodePoint(a))},s={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},n=a=>{Ui(a,s,t)};for(let a=0;a<r.length;a+=1)sr(r.charCodeAt(a),i,n);return e.join("")}function Ni(r,e){if(r<=127){e(r);return}else if(r<=2047){e(192|r>>6),e(128|r&63);return}else if(r<=65535){e(224|r>>12),e(128|r>>6&63),e(128|r&63);return}else if(r<=1114111){e(240|r>>18),e(128|r>>12&63),e(128|r>>6&63),e(128|r&63);return}throw new Error(`Unrecognized Unicode codepoint: ${r.toString(16)}`)}function Li(r,e){for(let t=0;t<r.length;t+=1){let s=r.charCodeAt(t);if(s>55295&&s<=56319){const i=(s-55296)*1024&65535;s=(r.charCodeAt(t+1)-56320&65535|i)+65536,t+=1}Ni(s,e)}}function Ui(r,e,t){if(e.utf8seq===0){if(r<=127){t(r);return}for(let s=1;s<6;s+=1)if(!(r>>7-s&1)){e.utf8seq=s;break}if(e.utf8seq===2)e.codepoint=r&31;else if(e.utf8seq===3)e.codepoint=r&15;else if(e.utf8seq===4)e.codepoint=r&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(r<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|r&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function be(r){const e=[],t={queue:0,queuedBits:0},s=i=>{e.push(i)};for(let i=0;i<r.length;i+=1)sr(r.charCodeAt(i),t,s);return new Uint8Array(e)}function qi(r){const e=[];return Li(r,t=>e.push(t)),new Uint8Array(e)}function de(r){const e=[],t={queue:0,queuedBits:0},s=i=>{e.push(i)};return r.forEach(i=>Jt(i,t,s)),Jt(null,t,s),e.join("")}function Di(r){return Math.round(Date.now()/1e3)+r}function Bi(){return Symbol("auth-callback")}const M=()=>typeof window<"u"&&typeof document<"u",ie={tested:!1,writable:!1},rr=()=>{if(!M())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(ie.tested)return ie.writable;const r=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(r,r),globalThis.localStorage.removeItem(r),ie.tested=!0,ie.writable=!0}catch{ie.tested=!0,ie.writable=!1}return ie.writable};function zi(r){const e={},t=new URL(r);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((i,n)=>{e[n]=i})}catch{}return t.searchParams.forEach((s,i)=>{e[i]=s}),e}const ir=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),Mi=r=>typeof r=="object"&&r!==null&&"status"in r&&"ok"in r&&"json"in r&&typeof r.json=="function",ye=async(r,e,t)=>{await r.setItem(e,JSON.stringify(t))},ne=async(r,e)=>{const t=await r.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},te=async(r,e)=>{await r.removeItem(e)};class Ye{constructor(){this.promise=new Ye.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Ye.promiseConstructor=Promise;function it(r){const e=r.split(".");if(e.length!==3)throw new bt("Invalid JWT structure");for(let s=0;s<e.length;s++)if(!Ti.test(e[s]))throw new bt("JWT not in base64url format");return{header:JSON.parse(Gt(e[0])),payload:JSON.parse(Gt(e[1])),signature:be(e[2]),raw:{header:e[0],payload:e[1]}}}async function Fi(r){return await new Promise(e=>{setTimeout(()=>e(null),r)})}function Vi(r,e){return new Promise((s,i)=>{(async()=>{for(let n=0;n<1/0;n++)try{const a=await r(n);if(!e(n,null,a)){s(a);return}}catch(a){if(!e(n,a)){i(a);return}}})()})}function Hi(r){return("0"+r.toString(16)).substr(-2)}function Wi(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=t.length;let i="";for(let n=0;n<56;n++)i+=t.charAt(Math.floor(Math.random()*s));return i}return crypto.getRandomValues(e),Array.from(e,Hi).join("")}async function Ki(r){const t=new TextEncoder().encode(r),s=await crypto.subtle.digest("SHA-256",t),i=new Uint8Array(s);return Array.from(i).map(n=>String.fromCharCode(n)).join("")}async function Ji(r){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),r;const t=await Ki(r);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function fe(r,e,t=!1){const s=Wi();let i=s;t&&(i+="/PASSWORD_RECOVERY"),await ye(r,`${e}-code-verifier`,i);const n=await Ji(s);return[n,s===n?"plain":"s256"]}const Gi=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Yi(r){const e=r.headers.get(vt);if(!e||!e.match(Gi))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function Qi(r){if(!r)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(r<=e)throw new Error("JWT has expired")}function Xi(r){switch(r){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Zi=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function pe(r){if(!Zi.test(r))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function nt(){const r={};return new Proxy(r,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const s=t.toString();if(s==="Symbol(Symbol.toPrimitive)"||s==="Symbol(Symbol.toStringTag)"||s==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function en(r,e){return new Proxy(r,{get:(t,s,i)=>{if(s==="__isInsecureUserWarningProxy")return!0;if(typeof s=="symbol"){const n=s.toString();if(n==="Symbol(Symbol.toPrimitive)"||n==="Symbol(Symbol.toStringTag)"||n==="Symbol(util.inspect.custom)"||n==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,s,i)}return!e.value&&typeof s=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,s,i)}})}function Yt(r){return JSON.parse(JSON.stringify(r))}const ae=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),tn=[502,503,504];async function Qt(r){var e;if(!Mi(r))throw new yt(ae(r),0);if(tn.includes(r.status))throw new yt(ae(r),r.status);let t;try{t=await r.json()}catch(n){throw new le(ae(n),n)}let s;const i=Yi(r);if(i&&i.getTime()>=tr["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?s=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(s=t.error_code),s){if(s==="weak_password")throw new Wt(ae(t),r.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(s==="session_not_found")throw new G}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((n,a)=>n&&typeof a=="string",!0))throw new Wt(ae(t),r.status,t.weak_password.reasons);throw new Ri(ae(t),r.status||500,s)}const sn=(r,e,t,s)=>{const i={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),i.body=JSON.stringify(s),Object.assign(Object.assign({},i),t))};async function C(r,e,t,s){var i;const n=Object.assign({},s==null?void 0:s.headers);n[vt]||(n[vt]=tr["2024-01-01"].name),s!=null&&s.jwt&&(n.Authorization=`Bearer ${s.jwt}`);const a=(i=s==null?void 0:s.query)!==null&&i!==void 0?i:{};s!=null&&s.redirectTo&&(a.redirect_to=s.redirectTo);const o=Object.keys(a).length?"?"+new URLSearchParams(a).toString():"",c=await rn(r,e,t+o,{headers:n,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(c):{data:Object.assign({},c),error:null}}async function rn(r,e,t,s,i,n){const a=sn(e,s,i,n);let o;try{o=await r(t,Object.assign({},a))}catch(c){throw console.error(c),new yt(ae(c),0)}if(o.ok||await Qt(o),s!=null&&s.noResolveJson)return o;try{return await o.json()}catch(c){await Qt(c)}}function Y(r){var e;let t=null;on(r)&&(t=Object.assign({},r),r.expires_at||(t.expires_at=Di(r.expires_in)));const s=(e=r.user)!==null&&e!==void 0?e:r;return{data:{session:t,user:s},error:null}}function Xt(r){const e=Y(r);return!e.error&&r.weak_password&&typeof r.weak_password=="object"&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.message&&typeof r.weak_password.message=="string"&&r.weak_password.reasons.reduce((t,s)=>t&&typeof s=="string",!0)&&(e.data.weak_password=r.weak_password),e}function se(r){var e;return{data:{user:(e=r.user)!==null&&e!==void 0?e:r},error:null}}function nn(r){return{data:r,error:null}}function an(r){const{action_link:e,email_otp:t,hashed_token:s,redirect_to:i,verification_type:n}=r,a=Ee(r,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:e,email_otp:t,hashed_token:s,redirect_to:i,verification_type:n},c=Object.assign({},a);return{data:{properties:o,user:c},error:null}}function Zt(r){return r}function on(r){return r.access_token&&r.refresh_token&&r.expires_in}const at=["global","local","others"];class cn{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=ir(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=at[0]){if(at.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${at.join(", ")}`);try{return await C(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(k(s))return{data:null,error:s};throw s}}async inviteUserByEmail(e,t={}){try{return await C(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:se})}catch(s){if(k(s))return{data:{user:null},error:s};throw s}}async generateLink(e){try{const{options:t}=e,s=Ee(e,["options"]),i=Object.assign(Object.assign({},s),t);return"newEmail"in s&&(i.new_email=s==null?void 0:s.newEmail,delete i.newEmail),await C(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:an,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(k(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await C(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:se})}catch(t){if(k(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,s,i,n,a,o,c;try{const l={nextPage:null,lastPage:0,total:0},d=await C(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&s!==void 0?s:"",per_page:(n=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:""},xform:Zt});if(d.error)throw d.error;const h=await d.json(),u=(a=d.headers.get("x-total-count"))!==null&&a!==void 0?a:0,f=(c=(o=d.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&c!==void 0?c:[];return f.length>0&&(f.forEach(p=>{const g=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),v=JSON.parse(p.split(";")[1].split("=")[1]);l[`${v}Page`]=g}),l.total=parseInt(u)),{data:Object.assign(Object.assign({},h),l),error:null}}catch(l){if(k(l))return{data:{users:[]},error:l};throw l}}async getUserById(e){pe(e);try{return await C(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:se})}catch(t){if(k(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){pe(e);try{return await C(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:se})}catch(s){if(k(s))return{data:{user:null},error:s};throw s}}async deleteUser(e,t=!1){pe(e);try{return await C(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:se})}catch(s){if(k(s))return{data:{user:null},error:s};throw s}}async _listFactors(e){pe(e.userId);try{const{data:t,error:s}=await C(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:t,error:s}}catch(t){if(k(t))return{data:null,error:t};throw t}}async _deleteFactor(e){pe(e.userId),pe(e.id);try{return{data:await C(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(k(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,s,i,n,a,o,c;try{const l={nextPage:null,lastPage:0,total:0},d=await C(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&s!==void 0?s:"",per_page:(n=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:""},xform:Zt});if(d.error)throw d.error;const h=await d.json(),u=(a=d.headers.get("x-total-count"))!==null&&a!==void 0?a:0,f=(c=(o=d.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&c!==void 0?c:[];return f.length>0&&(f.forEach(p=>{const g=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),v=JSON.parse(p.split(";")[1].split("=")[1]);l[`${v}Page`]=g}),l.total=parseInt(u)),{data:Object.assign(Object.assign({},h),l),error:null}}catch(l){if(k(l))return{data:{clients:[]},error:l};throw l}}async _createOAuthClient(e){try{return await C(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(k(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await C(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(k(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await C(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(k(s))return{data:null,error:s};throw s}}async _deleteOAuthClient(e){try{return await C(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(k(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await C(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(k(t))return{data:null,error:t};throw t}}}function es(r={}){return{getItem:e=>r[e]||null,setItem:(e,t)=>{r[e]=t},removeItem:e=>{delete r[e]}}}const me={debug:!!(globalThis&&rr()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class nr extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class ln extends nr{}async function dn(r,e,t){me.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",r,e);const s=new globalThis.AbortController;return e>0&&setTimeout(()=>{s.abort(),me.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",r)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(r,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async i=>{if(i){me.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",r,i.name);try{return await t()}finally{me.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",r,i.name)}}else{if(e===0)throw me.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",r),new ln(`Acquiring an exclusive Navigator LockManager lock "${r}" immediately failed`);if(me.debug)try{const n=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(n,null,"  "))}catch(n){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",n)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}function un(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function ar(r){if(!/^0x[a-fA-F0-9]{40}$/.test(r))throw new Error(`@supabase/auth-js: Address "${r}" is invalid.`);return r.toLowerCase()}function hn(r){return parseInt(r,16)}function fn(r){const e=new TextEncoder().encode(r);return"0x"+Array.from(e,s=>s.toString(16).padStart(2,"0")).join("")}function pn(r){var e;const{chainId:t,domain:s,expirationTime:i,issuedAt:n=new Date,nonce:a,notBefore:o,requestId:c,resources:l,scheme:d,uri:h,version:u}=r;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!s)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(a&&a.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${a}`);if(!h)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(u!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${u}`);if(!((e=r.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${r.statement}`)}const f=ar(r.address),p=d?`${d}://${s}`:s,g=r.statement?`${r.statement}
`:"",v=`${p} wants you to sign in with your Ethereum account:
${f}

${g}`;let E=`URI: ${h}
Version: ${u}
Chain ID: ${t}${a?`
Nonce: ${a}`:""}
Issued At: ${n.toISOString()}`;if(i&&(E+=`
Expiration Time: ${i.toISOString()}`),o&&(E+=`
Not Before: ${o.toISOString()}`),c&&(E+=`
Request ID: ${c}`),l){let _=`
Resources:`;for(const m of l){if(!m||typeof m!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${m}`);_+=`
- ${m}`}E+=_}return`${v}
${E}`}class L extends Error{constructor({message:e,code:t,cause:s,name:i}){var n;super(e,{cause:s}),this.__isWebAuthnError=!0,this.name=(n=i??(s instanceof Error?s.name:void 0))!==null&&n!==void 0?n:"Unknown Error",this.code=t}}class Ke extends L{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function mn({error:r,options:e}){var t,s,i;const{publicKey:n}=e;if(!n)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(e.signal instanceof AbortSignal)return new L({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else if(r.name==="ConstraintError"){if(((t=n.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new L({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:r});if(e.mediation==="conditional"&&((s=n.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new L({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:r});if(((i=n.authenticatorSelection)===null||i===void 0?void 0:i.userVerification)==="required")return new L({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:r})}else{if(r.name==="InvalidStateError")return new L({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:r});if(r.name==="NotAllowedError")return new L({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="NotSupportedError")return n.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new L({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:r}):new L({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:r});if(r.name==="SecurityError"){const a=window.location.hostname;if(or(a)){if(n.rp.id!==a)return new L({message:`The RP ID "${n.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new L({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="TypeError"){if(n.user.id.byteLength<1||n.user.id.byteLength>64)return new L({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:r})}else if(r.name==="UnknownError")return new L({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new L({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}function gn({error:r,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(e.signal instanceof AbortSignal)return new L({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else{if(r.name==="NotAllowedError")return new L({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="SecurityError"){const s=window.location.hostname;if(or(s)){if(t.rpId!==s)return new L({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new L({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="UnknownError")return new L({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new L({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}class vn{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const yn=new vn;function bn(r){if(!r)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(r);const{challenge:e,user:t,excludeCredentials:s}=r,i=Ee(r,["challenge","user","excludeCredentials"]),n=be(e).buffer,a=Object.assign(Object.assign({},t),{id:be(t.id).buffer}),o=Object.assign(Object.assign({},i),{challenge:n,user:a});if(s&&s.length>0){o.excludeCredentials=new Array(s.length);for(let c=0;c<s.length;c++){const l=s[c];o.excludeCredentials[c]=Object.assign(Object.assign({},l),{id:be(l.id).buffer,type:l.type||"public-key",transports:l.transports})}}return o}function wn(r){if(!r)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(r);const{challenge:e,allowCredentials:t}=r,s=Ee(r,["challenge","allowCredentials"]),i=be(e).buffer,n=Object.assign(Object.assign({},s),{challenge:i});if(t&&t.length>0){n.allowCredentials=new Array(t.length);for(let a=0;a<t.length;a++){const o=t[a];n.allowCredentials[a]=Object.assign(Object.assign({},o),{id:be(o.id).buffer,type:o.type||"public-key",transports:o.transports})}}return n}function _n(r){var e;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const t=r;return{id:r.id,rawId:r.id,response:{attestationObject:de(new Uint8Array(r.response.attestationObject)),clientDataJSON:de(new Uint8Array(r.response.clientDataJSON))},type:"public-key",clientExtensionResults:r.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function En(r){var e;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const t=r,s=r.getClientExtensionResults(),i=r.response;return{id:r.id,rawId:r.id,response:{authenticatorData:de(new Uint8Array(i.authenticatorData)),clientDataJSON:de(new Uint8Array(i.clientDataJSON)),signature:de(new Uint8Array(i.signature)),userHandle:i.userHandle?de(new Uint8Array(i.userHandle)):void 0},type:"public-key",clientExtensionResults:s,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function or(r){return r==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(r)}function ts(){var r,e;return!!(M()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((r=navigator==null?void 0:navigator.credentials)===null||r===void 0?void 0:r.create)=="function"&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.get)=="function")}async function Sn(r){try{const e=await navigator.credentials.create(r);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ke("Browser returned unexpected credential type",e)}:{data:null,error:new Ke("Empty credential response",e)}}catch(e){return{data:null,error:mn({error:e,options:r})}}}async function kn(r){try{const e=await navigator.credentials.get(r);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ke("Browser returned unexpected credential type",e)}:{data:null,error:new Ke("Empty credential response",e)}}catch(e){return{data:null,error:gn({error:e,options:r})}}}const Cn={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},On={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Je(...r){const e=i=>i!==null&&typeof i=="object"&&!Array.isArray(i),t=i=>i instanceof ArrayBuffer||ArrayBuffer.isView(i),s={};for(const i of r)if(i)for(const n in i){const a=i[n];if(a!==void 0)if(Array.isArray(a))s[n]=a;else if(t(a))s[n]=a;else if(e(a)){const o=s[n];e(o)?s[n]=Je(o,a):s[n]=Je(a)}else s[n]=a}return s}function jn(r,e){return Je(Cn,r,e||{})}function Tn(r,e){return Je(On,r,e||{})}class An{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:s,signal:i},n){try{const{data:a,error:o}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!a)return{data:null,error:o};const c=i??yn.createNewAbortSignal();if(a.webauthn.type==="create"){const{user:l}=a.webauthn.credential_options.publicKey;l.name||(l.name=`${l.id}:${s}`),l.displayName||(l.displayName=l.name)}switch(a.webauthn.type){case"create":{const l=jn(a.webauthn.credential_options.publicKey,n==null?void 0:n.create),{data:d,error:h}=await Sn({publicKey:l,signal:c});return d?{data:{factorId:e,challengeId:a.id,webauthn:{type:a.webauthn.type,credential_response:d}},error:null}:{data:null,error:h}}case"request":{const l=Tn(a.webauthn.credential_options.publicKey,n==null?void 0:n.request),{data:d,error:h}=await kn(Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:l,signal:c}));return d?{data:{factorId:e,challengeId:a.id,webauthn:{type:a.webauthn.type,credential_response:d}},error:null}:{data:null,error:h}}}}catch(a){return k(a)?{data:null,error:a}:{data:null,error:new le("Unexpected error in challenge",a)}}}async _verify({challengeId:e,factorId:t,webauthn:s}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:s})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},n){if(!t)return{data:null,error:new Pe("rpId is required for WebAuthn authentication")};try{if(!ts())return{data:null,error:new le("Browser does not support WebAuthn",null)};const{data:a,error:o}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:s},signal:i},{request:n});if(!a)return{data:null,error:o};const{webauthn:c}=a;return this._verify({factorId:e,challengeId:a.challengeId,webauthn:{type:c.type,rpId:t,rpOrigins:s,credential_response:c.credential_response}})}catch(a){return k(a)?{data:null,error:a}:{data:null,error:new le("Unexpected error in authenticate",a)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},n){if(!t)return{data:null,error:new Pe("rpId is required for WebAuthn registration")};try{if(!ts())return{data:null,error:new le("Browser does not support WebAuthn",null)};const{data:a,error:o}=await this._enroll({friendlyName:e});if(!a)return await this.client.mfa.listFactors().then(d=>{var h;return(h=d.data)===null||h===void 0?void 0:h.all.find(u=>u.factor_type==="webauthn"&&u.friendly_name===e&&u.status!=="unverified")}).then(d=>d?this.client.mfa.unenroll({factorId:d==null?void 0:d.id}):void 0),{data:null,error:o};const{data:c,error:l}=await this._challenge({factorId:a.id,friendlyName:a.friendly_name,webauthn:{rpId:t,rpOrigins:s},signal:i},{create:n});return c?this._verify({factorId:a.id,challengeId:c.challengeId,webauthn:{rpId:t,rpOrigins:s,type:c.webauthn.type,credential_response:c.webauthn.credential_response}}):{data:null,error:l}}catch(a){return k(a)?{data:null,error:a}:{data:null,error:new le("Unexpected error in register",a)}}}}un();const Rn={url:Ci,storageKey:Oi,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:ji,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1};async function ss(r,e,t){return await t()}const ge={};class Ie{get jwks(){var e,t;return(t=(e=ge[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){ge[this.storageKey]=Object.assign(Object.assign({},ge[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=ge[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){ge[this.storageKey]=Object.assign(Object.assign({},ge[this.storageKey]),{cachedAt:e})}constructor(e){var t,s,i;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const n=Object.assign(Object.assign({},Rn),e);if(this.storageKey=n.storageKey,this.instanceID=(t=Ie.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,Ie.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!n.debug,typeof n.debug=="function"&&(this.logger=n.debug),this.instanceID>0&&M()){const a=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(a),this.logDebugMessages&&console.trace(a)}if(this.persistSession=n.persistSession,this.autoRefreshToken=n.autoRefreshToken,this.admin=new cn({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=ir(n.fetch),this.lock=n.lock||ss,this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.hasCustomAuthorizationHeader=n.hasCustomAuthorizationHeader,this.throwOnError=n.throwOnError,n.lock?this.lock=n.lock:M()&&(!((s=globalThis==null?void 0:globalThis.navigator)===null||s===void 0)&&s.locks)?this.lock=dn:this.lock=ss,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new An(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this)},this.persistSession?(n.storage?this.storage=n.storage:rr()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=es(this.memoryStorage)),n.userStorage&&(this.userStorage=n.userStorage)):(this.memoryStorage={},this.storage=es(this.memoryStorage)),M()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(a){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",a)}(i=this.broadcastChannel)===null||i===void 0||i.addEventListener("message",async a=>{this._debug("received broadcast notification from other tab or client",a),await this._notifyAllSubscribers(a.data.event,a.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${er}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},s="none";if(M()&&(t=zi(window.location.href),this._isImplicitGrantCallback(t)?s="implicit":await this._isPKCECallback(t)&&(s="pkce")),M()&&this.detectSessionInUrl&&s!=="none"){const{data:i,error:n}=await this._getSessionFromURL(t,s);if(n){if(this._debug("#_initialize()","error detecting session from URL",n),xi(n)){const c=(e=n.details)===null||e===void 0?void 0:e.code;if(c==="identity_already_exists"||c==="identity_not_found"||c==="single_identity_not_deletable")return{error:n}}return await this._removeSession(),{error:n}}const{session:a,redirectType:o}=i;return this._debug("#_initialize()","detected session in URL",a,"redirect type",o),await this._saveSession(a),setTimeout(async()=>{o==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",a):await this._notifyAllSubscribers("SIGNED_IN",a)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return k(t)?this._returnResult({error:t}):this._returnResult({error:new le("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,s,i;try{const n=await C(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.captchaToken}},xform:Y}),{data:a,error:o}=n;if(o||!a)return this._returnResult({data:{user:null,session:null},error:o});const c=a.session,l=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(n){if(k(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signUp(e){var t,s,i;try{let n;if("email"in e){const{email:d,password:h,options:u}=e;let f=null,p=null;this.flowType==="pkce"&&([f,p]=await fe(this.storage,this.storageKey)),n=await C(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:u==null?void 0:u.emailRedirectTo,body:{email:d,password:h,data:(t=u==null?void 0:u.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken},code_challenge:f,code_challenge_method:p},xform:Y})}else if("phone"in e){const{phone:d,password:h,options:u}=e;n=await C(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:h,data:(s=u==null?void 0:u.data)!==null&&s!==void 0?s:{},channel:(i=u==null?void 0:u.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken}},xform:Y})}else throw new ze("You must provide either an email or phone number and a password");const{data:a,error:o}=n;if(o||!a)return this._returnResult({data:{user:null,session:null},error:o});const c=a.session,l=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(n){if(k(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithPassword(e){try{let t;if("email"in e){const{email:n,password:a,options:o}=e;t=await C(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:n,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:Xt})}else if("phone"in e){const{phone:n,password:a,options:o}=e;t=await C(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:n,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:Xt})}else throw new ze("You must provide either an email or phone number and a password");const{data:s,error:i}=t;if(i)return this._returnResult({data:{user:null,session:null},error:i});if(!s||!s.session||!s.user){const n=new he;return this._returnResult({data:{user:null,session:null},error:n})}return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),this._returnResult({data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:i})}catch(t){if(k(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,s,i,n;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(s=e.options)===null||s===void 0?void 0:s.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(n=e.options)===null||n===void 0?void 0:n.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,s,i,n,a,o,c,l,d,h,u;let f,p;if("message"in e)f=e.message,p=e.signature;else{const{chain:g,wallet:v,statement:E,options:_}=e;let m;if(M())if(typeof v=="object")m=v;else{const U=window;if("ethereum"in U&&typeof U.ethereum=="object"&&"request"in U.ethereum&&typeof U.ethereum.request=="function")m=U.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof v!="object"||!(_!=null&&_.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");m=v}const b=new URL((t=_==null?void 0:_.url)!==null&&t!==void 0?t:window.location.href),T=await m.request({method:"eth_requestAccounts"}).then(U=>U).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!T||T.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const A=ar(T[0]);let P=(s=_==null?void 0:_.signInWithEthereum)===null||s===void 0?void 0:s.chainId;if(!P){const U=await m.request({method:"eth_chainId"});P=hn(U)}const D={domain:b.host,address:A,statement:E,uri:b.href,version:"1",chainId:P,nonce:(i=_==null?void 0:_.signInWithEthereum)===null||i===void 0?void 0:i.nonce,issuedAt:(a=(n=_==null?void 0:_.signInWithEthereum)===null||n===void 0?void 0:n.issuedAt)!==null&&a!==void 0?a:new Date,expirationTime:(o=_==null?void 0:_.signInWithEthereum)===null||o===void 0?void 0:o.expirationTime,notBefore:(c=_==null?void 0:_.signInWithEthereum)===null||c===void 0?void 0:c.notBefore,requestId:(l=_==null?void 0:_.signInWithEthereum)===null||l===void 0?void 0:l.requestId,resources:(d=_==null?void 0:_.signInWithEthereum)===null||d===void 0?void 0:d.resources};f=pn(D),p=await m.request({method:"personal_sign",params:[fn(f),A]})}try{const{data:g,error:v}=await C(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:f,signature:p},!((h=e.options)===null||h===void 0)&&h.captchaToken?{gotrue_meta_security:{captcha_token:(u=e.options)===null||u===void 0?void 0:u.captchaToken}}:null),xform:Y});if(v)throw v;if(!g||!g.session||!g.user){const E=new he;return this._returnResult({data:{user:null,session:null},error:E})}return g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),this._returnResult({data:Object.assign({},g),error:v})}catch(g){if(k(g))return this._returnResult({data:{user:null,session:null},error:g});throw g}}async signInWithSolana(e){var t,s,i,n,a,o,c,l,d,h,u,f;let p,g;if("message"in e)p=e.message,g=e.signature;else{const{chain:v,wallet:E,statement:_,options:m}=e;let b;if(M())if(typeof E=="object")b=E;else{const A=window;if("solana"in A&&typeof A.solana=="object"&&("signIn"in A.solana&&typeof A.solana.signIn=="function"||"signMessage"in A.solana&&typeof A.solana.signMessage=="function"))b=A.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof E!="object"||!(m!=null&&m.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");b=E}const T=new URL((t=m==null?void 0:m.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in b&&b.signIn){const A=await b.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},m==null?void 0:m.signInWithSolana),{version:"1",domain:T.host,uri:T.href}),_?{statement:_}:null));let P;if(Array.isArray(A)&&A[0]&&typeof A[0]=="object")P=A[0];else if(A&&typeof A=="object"&&"signedMessage"in A&&"signature"in A)P=A;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in P&&"signature"in P&&(typeof P.signedMessage=="string"||P.signedMessage instanceof Uint8Array)&&P.signature instanceof Uint8Array)p=typeof P.signedMessage=="string"?P.signedMessage:new TextDecoder().decode(P.signedMessage),g=P.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in b)||typeof b.signMessage!="function"||!("publicKey"in b)||typeof b!="object"||!b.publicKey||!("toBase58"in b.publicKey)||typeof b.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");p=[`${T.host} wants you to sign in with your Solana account:`,b.publicKey.toBase58(),..._?["",_,""]:[""],"Version: 1",`URI: ${T.href}`,`Issued At: ${(i=(s=m==null?void 0:m.signInWithSolana)===null||s===void 0?void 0:s.issuedAt)!==null&&i!==void 0?i:new Date().toISOString()}`,...!((n=m==null?void 0:m.signInWithSolana)===null||n===void 0)&&n.notBefore?[`Not Before: ${m.signInWithSolana.notBefore}`]:[],...!((a=m==null?void 0:m.signInWithSolana)===null||a===void 0)&&a.expirationTime?[`Expiration Time: ${m.signInWithSolana.expirationTime}`]:[],...!((o=m==null?void 0:m.signInWithSolana)===null||o===void 0)&&o.chainId?[`Chain ID: ${m.signInWithSolana.chainId}`]:[],...!((c=m==null?void 0:m.signInWithSolana)===null||c===void 0)&&c.nonce?[`Nonce: ${m.signInWithSolana.nonce}`]:[],...!((l=m==null?void 0:m.signInWithSolana)===null||l===void 0)&&l.requestId?[`Request ID: ${m.signInWithSolana.requestId}`]:[],...!((h=(d=m==null?void 0:m.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||h===void 0)&&h.length?["Resources",...m.signInWithSolana.resources.map(P=>`- ${P}`)]:[]].join(`
`);const A=await b.signMessage(new TextEncoder().encode(p),"utf8");if(!A||!(A instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");g=A}}try{const{data:v,error:E}=await C(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:p,signature:de(g)},!((u=e.options)===null||u===void 0)&&u.captchaToken?{gotrue_meta_security:{captcha_token:(f=e.options)===null||f===void 0?void 0:f.captchaToken}}:null),xform:Y});if(E)throw E;if(!v||!v.session||!v.user){const _=new he;return this._returnResult({data:{user:null,session:null},error:_})}return v.session&&(await this._saveSession(v.session),await this._notifyAllSubscribers("SIGNED_IN",v.session)),this._returnResult({data:Object.assign({},v),error:E})}catch(v){if(k(v))return this._returnResult({data:{user:null,session:null},error:v});throw v}}async _exchangeCodeForSession(e){const t=await ne(this.storage,`${this.storageKey}-code-verifier`),[s,i]=(t??"").split("/");try{const{data:n,error:a}=await C(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:Y});if(await te(this.storage,`${this.storageKey}-code-verifier`),a)throw a;if(!n||!n.session||!n.user){const o=new he;return this._returnResult({data:{user:null,session:null,redirectType:null},error:o})}return n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",n.session)),this._returnResult({data:Object.assign(Object.assign({},n),{redirectType:i??null}),error:a})}catch(n){if(k(n))return this._returnResult({data:{user:null,session:null,redirectType:null},error:n});throw n}}async signInWithIdToken(e){try{const{options:t,provider:s,token:i,access_token:n,nonce:a}=e,o=await C(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:i,access_token:n,nonce:a,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:Y}),{data:c,error:l}=o;if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!c||!c.session||!c.user){const d=new he;return this._returnResult({data:{user:null,session:null},error:d})}return c.session&&(await this._saveSession(c.session),await this._notifyAllSubscribers("SIGNED_IN",c.session)),this._returnResult({data:c,error:l})}catch(t){if(k(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,s,i,n,a;try{if("email"in e){const{email:o,options:c}=e;let l=null,d=null;this.flowType==="pkce"&&([l,d]=await fe(this.storage,this.storageKey));const{error:h}=await C(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(t=c==null?void 0:c.data)!==null&&t!==void 0?t:{},create_user:(s=c==null?void 0:c.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},code_challenge:l,code_challenge_method:d},redirectTo:c==null?void 0:c.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:h})}if("phone"in e){const{phone:o,options:c}=e,{data:l,error:d}=await C(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(i=c==null?void 0:c.data)!==null&&i!==void 0?i:{},create_user:(n=c==null?void 0:c.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},channel:(a=c==null?void 0:c.channel)!==null&&a!==void 0?a:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:d})}throw new ze("You must provide either an email or phone number.")}catch(o){if(k(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async verifyOtp(e){var t,s;try{let i,n;"options"in e&&(i=(t=e.options)===null||t===void 0?void 0:t.redirectTo,n=(s=e.options)===null||s===void 0?void 0:s.captchaToken);const{data:a,error:o}=await C(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:n}}),redirectTo:i,xform:Y});if(o)throw o;if(!a)throw new Error("An error occurred on token verification.");const c=a.session,l=a.user;return c!=null&&c.access_token&&(await this._saveSession(c),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(i){if(k(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithSSO(e){var t,s,i,n,a;try{let o=null,c=null;this.flowType==="pkce"&&([o,c]=await fe(this.storage,this.storageKey));const l=await C(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&s!==void 0?s:void 0}),!((i=e==null?void 0:e.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:o,code_challenge_method:c}),headers:this.headers,xform:nn});return!((n=l.data)===null||n===void 0)&&n.url&&M()&&!(!((a=e.options)===null||a===void 0)&&a.skipBrowserRedirect)&&window.location.assign(l.data.url),this._returnResult(l)}catch(o){if(k(o))return this._returnResult({data:null,error:o});throw o}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new G;const{error:i}=await C(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:i})})}catch(e){if(k(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:s,type:i,options:n}=e,{error:a}=await C(this.fetch,"POST",t,{headers:this.headers,body:{email:s,type:i,gotrue_meta_security:{captcha_token:n==null?void 0:n.captchaToken}},redirectTo:n==null?void 0:n.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:a})}else if("phone"in e){const{phone:s,type:i,options:n}=e,{data:a,error:o}=await C(this.fetch,"POST",t,{headers:this.headers,body:{phone:s,type:i,gotrue_meta_security:{captcha_token:n==null?void 0:n.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:a==null?void 0:a.message_id},error:o})}throw new ze("You must provide either an email or phone number and a type")}catch(t){if(k(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await s,await t()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=t();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await ne(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=e.expires_at?e.expires_at*1e3-Date.now()<st:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.userStorage){const a=await ne(this.userStorage,this.storageKey+"-user");a!=null&&a.user?e.user=a.user:e.user=nt()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const a={value:this.suppressGetSessionWarning};e.user=en(e.user,a),a.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:i,error:n}=await this._callRefreshToken(e.refresh_token);return n?this._returnResult({data:{session:null},error:n}):this._returnResult({data:{session:i},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await C(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:se}):await this._useSession(async t=>{var s,i,n;const{data:a,error:o}=t;if(o)throw o;return!(!((s=a.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new G}:await C(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(n=(i=a.session)===null||i===void 0?void 0:i.access_token)!==null&&n!==void 0?n:void 0,xform:se})})}catch(t){if(k(t))return Ii(t)&&(await this._removeSession(),await te(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async s=>{const{data:i,error:n}=s;if(n)throw n;if(!i.session)throw new G;const a=i.session;let o=null,c=null;this.flowType==="pkce"&&e.email!=null&&([o,c]=await fe(this.storage,this.storageKey));const{data:l,error:d}=await C(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:c}),jwt:a.access_token,xform:se});if(d)throw d;return a.user=l.user,await this._saveSession(a),await this._notifyAllSubscribers("USER_UPDATED",a),this._returnResult({data:{user:a.user},error:null})})}catch(s){if(k(s))return this._returnResult({data:{user:null},error:s});throw s}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new G;const t=Date.now()/1e3;let s=t,i=!0,n=null;const{payload:a}=it(e.access_token);if(a.exp&&(s=a.exp,i=s<=t),i){const{data:o,error:c}=await this._callRefreshToken(e.refresh_token);if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!o)return{data:{user:null,session:null},error:null};n=o}else{const{data:o,error:c}=await this._getUser(e.access_token);if(c)throw c;n={access_token:e.access_token,refresh_token:e.refresh_token,user:o.user,token_type:"bearer",expires_in:s-t,expires_at:s},await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)}return this._returnResult({data:{user:n.user,session:n},error:null})}catch(t){if(k(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var s;if(!e){const{data:a,error:o}=t;if(o)throw o;e=(s=a.session)!==null&&s!==void 0?s:void 0}if(!(e!=null&&e.refresh_token))throw new G;const{data:i,error:n}=await this._callRefreshToken(e.refresh_token);return n?this._returnResult({data:{user:null,session:null},error:n}):i?this._returnResult({data:{user:i.user,session:i},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(k(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!M())throw new Me("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Me(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Ht("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Me("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Ht("No code detected.");const{data:_,error:m}=await this._exchangeCodeForSession(e.code);if(m)throw m;const b=new URL(window.location.href);return b.searchParams.delete("code"),window.history.replaceState(window.history.state,"",b.toString()),{data:{session:_.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:i,access_token:n,refresh_token:a,expires_in:o,expires_at:c,token_type:l}=e;if(!n||!o||!a||!l)throw new Me("No session defined in URL");const d=Math.round(Date.now()/1e3),h=parseInt(o);let u=d+h;c&&(u=parseInt(c));const f=u-d;f*1e3<=ve&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${h}s`);const p=u-h;d-p>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",p,u,d):d-p<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",p,u,d);const{data:g,error:v}=await this._getUser(n);if(v)throw v;const E={provider_token:s,provider_refresh_token:i,access_token:n,expires_in:h,expires_at:u,refresh_token:a,token_type:l,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:E,redirectType:e.type},error:null})}catch(s){if(k(s))return this._returnResult({data:{session:null,redirectType:null},error:s});throw s}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await ne(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var s;const{data:i,error:n}=t;if(n)return this._returnResult({error:n});const a=(s=i.session)===null||s===void 0?void 0:s.access_token;if(a){const{error:o}=await this.admin.signOut(a,e);if(o&&!(Pi(o)&&(o.status===404||o.status===401||o.status===403)))return this._returnResult({error:o})}return e!=="others"&&(await this._removeSession(),await te(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=Bi(),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async t=>{var s,i;try{const{data:{session:n},error:a}=t;if(a)throw a;await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",n)),this._debug("INITIAL_SESSION","callback id",e,"session",n)}catch(n){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",n),console.error(n)}})}async resetPasswordForEmail(e,t={}){let s=null,i=null;this.flowType==="pkce"&&([s,i]=await fe(this.storage,this.storageKey,!0));try{return await C(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(n){if(k(n))return this._returnResult({data:null,error:n});throw n}}async getUserIdentities(){var e;try{const{data:t,error:s}=await this.getUser();if(s)throw s;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if(k(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:s,error:i}=await this._useSession(async n=>{var a,o,c,l,d;const{data:h,error:u}=n;if(u)throw u;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(a=e.options)===null||a===void 0?void 0:a.redirectTo,scopes:(o=e.options)===null||o===void 0?void 0:o.scopes,queryParams:(c=e.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:!0});return await C(this.fetch,"GET",f,{headers:this.headers,jwt:(d=(l=h.session)===null||l===void 0?void 0:l.access_token)!==null&&d!==void 0?d:void 0})});if(i)throw i;return M()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),this._returnResult({data:{provider:e.provider,url:s==null?void 0:s.url},error:null})}catch(s){if(k(s))return this._returnResult({data:{provider:e.provider,url:null},error:s});throw s}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var s;try{const{error:i,data:{session:n}}=t;if(i)throw i;const{options:a,provider:o,token:c,access_token:l,nonce:d}=e,h=await C(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(s=n==null?void 0:n.access_token)!==null&&s!==void 0?s:void 0,body:{provider:o,id_token:c,access_token:l,nonce:d,link_identity:!0,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:Y}),{data:u,error:f}=h;return f?this._returnResult({data:{user:null,session:null},error:f}):!u||!u.session||!u.user?this._returnResult({data:{user:null,session:null},error:new he}):(u.session&&(await this._saveSession(u.session),await this._notifyAllSubscribers("USER_UPDATED",u.session)),this._returnResult({data:u,error:f}))}catch(i){if(k(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var s,i;const{data:n,error:a}=t;if(a)throw a;return await C(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(s=n.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0})})}catch(t){if(k(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const s=Date.now();return await Vi(async i=>(i>0&&await Fi(200*Math.pow(2,i-1)),this._debug(t,"refreshing attempt",i),await C(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Y})),(i,n)=>{const a=200*Math.pow(2,i);return n&&rt(n)&&Date.now()+a-s<ve})}catch(s){if(this._debug(t,"error",s),k(s))return this._returnResult({data:{session:null,user:null},error:s});throw s}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),M()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e,t;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const i=await ne(this.storage,this.storageKey);if(i&&this.userStorage){let a=await ne(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!a&&(a={user:i.user},await ye(this.userStorage,this.storageKey+"-user",a)),i.user=(e=a==null?void 0:a.user)!==null&&e!==void 0?e:nt()}else if(i&&!i.user&&!i.user){const a=await ne(this.storage,this.storageKey+"-user");a&&(a!=null&&a.user)?(i.user=a.user,await te(this.storage,this.storageKey+"-user"),await ye(this.storage,this.storageKey,i)):i.user=nt()}if(this._debug(s,"session from storage",i),!this._isValidSession(i)){this._debug(s,"session is not valid"),i!==null&&await this._removeSession();return}const n=((t=i.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<st;if(this._debug(s,`session has${n?"":" not"} expired with margin of ${st}s`),n){if(this.autoRefreshToken&&i.refresh_token){const{error:a}=await this._callRefreshToken(i.refresh_token);a&&(console.error(a),rt(a)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",a),await this._removeSession()))}}else if(i.user&&i.user.__isUserNotAvailableProxy===!0)try{const{data:a,error:o}=await this._getUser(i.access_token);!o&&(a!=null&&a.user)?(i.user=a.user,await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(a){console.error("Error getting user data:",a),this._debug(s,"error getting user data, skipping SIGNED_IN notification",a)}else await this._notifyAllSubscribers("SIGNED_IN",i)}catch(i){this._debug(s,"error",i),console.error(i);return}finally{this._debug(s,"end")}}async _callRefreshToken(e){var t,s;if(!e)throw new G;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new Ye;const{data:n,error:a}=await this._refreshAccessToken(e);if(a)throw a;if(!n.session)throw new G;await this._saveSession(n.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",n.session);const o={data:n.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(n){if(this._debug(i,"error",n),k(n)){const a={data:null,error:n};return rt(n)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(a),a}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(n),n}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,t,s=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const n=[],a=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(e,t)}catch(c){n.push(c)}});if(await Promise.all(a),n.length>0){for(let o=0;o<n.length;o+=1)console.error(n[o]);throw n[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;const t=Object.assign({},e),s=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!s&&t.user&&await ye(this.userStorage,this.storageKey+"-user",{user:t.user});const i=Object.assign({},t);delete i.user;const n=Yt(i);await ye(this.storage,this.storageKey,n)}else{const i=Yt(t);await ye(this.storage,this.storageKey,i)}}async _removeSession(){this._debug("#_removeSession()"),await te(this.storage,this.storageKey),await te(this.storage,this.storageKey+"-code-verifier"),await te(this.storage,this.storageKey+"-user"),this.userStorage&&await te(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&M()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),ve);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:s}}=t;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((s.expires_at*1e3-e)/ve);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${ve}ms, refresh threshold is ${gt} ticks`),i<=gt&&await this._callRefreshToken(s.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof nr)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!M()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,s){const i=[`provider=${encodeURIComponent(t)}`];if(s!=null&&s.redirectTo&&i.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&i.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[n,a]=await fe(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(n)}`,code_challenge_method:`${encodeURIComponent(a)}`});i.push(o.toString())}if(s!=null&&s.queryParams){const n=new URLSearchParams(s.queryParams);i.push(n.toString())}return s!=null&&s.skipBrowserRedirect&&i.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var s;const{data:i,error:n}=t;return n?this._returnResult({data:null,error:n}):await C(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token})})}catch(t){if(k(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var s,i;const{data:n,error:a}=t;if(a)return this._returnResult({data:null,error:a});const o=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:c,error:l}=await C(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});return l?this._returnResult({data:null,error:l}):(e.factorType==="totp"&&c.type==="totp"&&(!((i=c==null?void 0:c.totp)===null||i===void 0)&&i.qr_code)&&(c.totp.qr_code=`data:image/svg+xml;utf-8,${c.totp.qr_code}`),this._returnResult({data:c,error:null}))})}catch(t){if(k(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:i,error:n}=t;if(n)return this._returnResult({data:null,error:n});const a=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?_n(e.webauthn.credential_response):En(e.webauthn.credential_response)})}:{code:e.code}),{data:o,error:c}=await C(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:a,headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token});return c?this._returnResult({data:null,error:c}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),this._returnResult({data:o,error:c}))})}catch(t){if(k(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:i,error:n}=t;if(n)return this._returnResult({data:null,error:n});const a=await C(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token});if(a.error)return a;const{data:o}=a;if(o.type!=="webauthn")return{data:o,error:null};switch(o.webauthn.type){case"create":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:bn(o.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:wn(o.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(k(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:s}=await this._challenge({factorId:e.factorId});return s?this._returnResult({data:null,error:s}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:s}=await this.getUser();if(s)return{data:null,error:s};const i={all:[],phone:[],totp:[],webauthn:[]};for(const n of(e=t==null?void 0:t.factors)!==null&&e!==void 0?e:[])i.all.push(n),n.status==="verified"&&i[n.factor_type].push(n);return{data:i,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:s},error:i}=await this.getSession();if(i)return this._returnResult({data:null,error:i});if(!s)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:n}=it(s.access_token);let a=null;n.aal&&(a=n.aal);let o=a;((t=(e=s.user.factors)===null||e===void 0?void 0:e.filter(d=>d.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(o="aal2");const l=n.amr||[];return{data:{currentLevel:a,nextLevel:o,currentAuthenticationMethods:l},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:s},error:i}=t;return i?this._returnResult({data:null,error:i}):s?await C(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:s.access_token,xform:n=>({data:n,error:null})}):this._returnResult({data:null,error:new G})})}catch(t){if(k(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async s=>{const{data:{session:i},error:n}=s;if(n)return this._returnResult({data:null,error:n});if(!i)return this._returnResult({data:null,error:new G});const a=await C(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"approve"},xform:o=>({data:o,error:null})});return a.data&&a.data.redirect_url&&M()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(a.data.redirect_url),a})}catch(s){if(k(s))return this._returnResult({data:null,error:s});throw s}}async _denyAuthorization(e,t){try{return await this._useSession(async s=>{const{data:{session:i},error:n}=s;if(n)return this._returnResult({data:null,error:n});if(!i)return this._returnResult({data:null,error:new G});const a=await C(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"deny"},xform:o=>({data:o,error:null})});return a.data&&a.data.redirect_url&&M()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(a.data.redirect_url),a})}catch(s){if(k(s))return this._returnResult({data:null,error:s});throw s}}async fetchJwk(e,t={keys:[]}){let s=t.keys.find(o=>o.kid===e);if(s)return s;const i=Date.now();if(s=this.jwks.keys.find(o=>o.kid===e),s&&this.jwks_cached_at+Ai>i)return s;const{data:n,error:a}=await C(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(a)throw a;return!n.keys||n.keys.length===0||(this.jwks=n,this.jwks_cached_at=i,s=n.keys.find(o=>o.kid===e),!s)?null:s}async getClaims(e,t={}){try{let s=e;if(!s){const{data:f,error:p}=await this.getSession();if(p||!f.session)return this._returnResult({data:null,error:p});s=f.session.access_token}const{header:i,payload:n,signature:a,raw:{header:o,payload:c}}=it(s);t!=null&&t.allowExpired||Qi(n.exp);const l=!i.alg||i.alg.startsWith("HS")||!i.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(i.kid,t!=null&&t.keys?{keys:t.keys}:t==null?void 0:t.jwks);if(!l){const{error:f}=await this.getUser(s);if(f)throw f;return{data:{claims:n,header:i,signature:a},error:null}}const d=Xi(i.alg),h=await crypto.subtle.importKey("jwk",l,d,!0,["verify"]);if(!await crypto.subtle.verify(d,h,a,qi(`${o}.${c}`)))throw new bt("Invalid JWT signature");return{data:{claims:n,header:i,signature:a},error:null}}catch(s){if(k(s))return this._returnResult({data:null,error:s});throw s}}}Ie.nextInstanceID={};const Pn=Ie;class In extends Pn{constructor(e){super(e)}}class xn{constructor(e,t,s){var i,n,a;this.supabaseUrl=e,this.supabaseKey=t;const o=ki(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const c=`sb-${o.hostname.split(".")[0]}-auth-token`,l={db:gi,realtime:yi,auth:Object.assign(Object.assign({},vi),{storageKey:c}),global:mi},d=Si(s??{},l);this.storageKey=(i=d.auth.storageKey)!==null&&i!==void 0?i:"",this.headers=(n=d.global.headers)!==null&&n!==void 0?n:{},d.accessToken?(this.accessToken=d.accessToken,this.auth=new Proxy({},{get:(h,u)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(u)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((a=d.auth)!==null&&a!==void 0?a:{},this.headers,d.global.fetch),this.fetch=_i(t,this._getAccessToken.bind(this),d.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},d.realtime)),this.accessToken&&this.accessToken().then(h=>this.realtime.setAuth(h)).catch(h=>console.warn("Failed to set initial Realtime auth token:",h)),this.rest=new Cr(new URL("rest/v1",o).href,{headers:this.headers,schema:d.db.schema,fetch:this.fetch}),this.storage=new hi(this.storageUrl.href,this.headers,this.fetch,s==null?void 0:s.storage),d.accessToken||this._listenForAuthEvents()}get functions(){return new _r(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},s={head:!1,get:!1,count:void 0}){return this.rest.rpc(e,t,s)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var e,t;if(this.accessToken)return await this.accessToken();const{data:s}=await this.auth.getSession();return(t=(e=s.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:this.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:i,userStorage:n,storageKey:a,flowType:o,lock:c,debug:l,throwOnError:d},h,u){const f={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new In({url:this.authUrl.href,headers:Object.assign(Object.assign({},f),h),storageKey:a,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:i,userStorage:n,flowType:o,lock:c,debug:l,throwOnError:d,fetch:u,hasCustomAuthorizationHeader:Object.keys(this.headers).some(p=>p.toLowerCase()==="authorization")})}_initRealtimeClient(e){return new Mr(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,s)=>{this._handleTokenChanged(t,"CLIENT",s==null?void 0:s.access_token)})}_handleTokenChanged(e,t,s){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==s?(this.changedAccessToken=s,this.realtime.setAuth(s)):e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const $n=(r,e,t)=>new xn(r,e,t);function Nn(){if(typeof window<"u"||typeof process>"u")return!1;const r=process.version;if(r==null)return!1;const e=r.match(/^v(\d+)\./);return e?parseInt(e[1],10)<=18:!1}Nn()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Ln="https://hkxugotjfkyalmlkojhq.supabase.co",Un="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhreHVnb3RqZmt5YWxtbGtvamhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODk3MTAsImV4cCI6MjA3Nzc2NTcxMH0.mV21rbO4K5gfmYWF_ZB5mcjPG2TLu80w0SOMBCoDkaE",qn=Ln,Dn=Un,N=$n(qn,Dn),cr=[{codigo:"1.1",pregunta:"Se han identificado el contexto interno y externo que afecta la gestin ambiental del predio (factores sociales, legales, tecnolgicos, educativos, ambientales, etc.)?",queImplica:"El contexto permite comprender las condiciones internas y externas que influyen en la gestin del predio. Incluye aspectos sociales, ambientales, legales, econmicos, tecnolgicos y educativos que pueden afectar su desempeo o cumplimiento de objetivos. Este anlisis ayuda a anticipar riesgos, aprovechar oportunidades y orientar la planificacin de las actividades.",comoCumplir:" Identificar los factores internos (infraestructura, recursos, cultura organizacional, procesos).  Identificar los factores externos (legislacin, comunidad, entorno ambiental, tecnologa, expectativas sociales).  Analizar cmo estos factores pueden afectar el desempeo o el cumplimiento de requisitos.  Revisar y actualizar el anlisis cuando haya cambios importantes en el contexto (nuevas leyes, modificaciones en las actividades o en el entorno).",evidencias:" Documento o matriz de anlisis del contexto.  Actas de reuniones o talleres donde se haya discutido el contexto.  Informes de diagnstico ambiental o institucional.  Planes estratgicos o de desarrollo del predio.  Anlisis DOFA o similar (debilidades, oportunidades, fortalezas y amenazas).",criterios:{1:"1: No se ha realizado ningn anlisis del contexto.",2:"2: Se tiene conocimiento general de los factores, pero no estn documentados.",3:"3: Existe un anlisis parcial o desactualizado.",4:"4: El contexto est identificado, documentado y actualizado.",5:"5: El contexto se revisa peridicamente y se usa para la toma de decisiones y la planificacin del predio."}},{codigo:"1.2",pregunta:"Se han identificado las partes interesadas relevantes para la gestin ambiental (estudiantes, docentes, comunidad, autoridades, proveedores, etc.) y se han determinado sus necesidades y expectativas?",queImplica:"Las partes interesadas son todas aquellas personas, grupos o entidades que pueden influir o verse afectadas por las actividades del predio. Conocer quines son y qu esperan permite planificar mejor las acciones, cumplir requisitos legales y fortalecer la relacin con la comunidad. Este anlisis ayuda a que la gestin sea ms efectiva y responda a las necesidades reales del entorno.",comoCumplir:" Elaborar una lista o matriz con las partes interesadas relevantes del predio.  Determinar las necesidades, expectativas o requisitos de cada parte (por ejemplo: cumplimiento de normas, informacin, seguridad, calidad del servicio, participacin).  Definir acciones o mecanismos para atender esas necesidades (comunicaciones, programas, controles o acuerdos).  Revisar y actualizar la informacin peridicamente, especialmente si cambian las actividades o el entorno del predio).",evidencias:" Matriz de partes interesadas y sus necesidades o expectativas.  Registros de reuniones o comunicaciones con partes interesadas.  Programas o estrategias de participacin y comunicacin.  Encuestas de satisfaccin o informes de gestin social.  Actas de comits, visitas o actividades conjuntas.",criterios:{1:"1: No se han identificado las partes interesadas ni sus necesidades.",2:"2: Se conocen algunas partes interesadas, pero sin registro formal.",3:"3: Existe una lista parcial o desactualizada de partes interesadas.",4:"4: Las partes interesadas estn identificadas, con necesidades documentadas y acciones definidas.",5:"5: La informacin est actualizada, se revisa regularmente y se usa en la planificacin y mejora del predio."}},{codigo:"1.3",pregunta:"Est claramente definido el alcance del sistema integrado de gestin ambiental (por ejemplo: procesos, reas, sedes o unidades incluidas, y exclusiones justificadas)?",queImplica:"El alcance define qu actividades, procesos, reas o servicios estn cubiertos por el sistema integrado de gestin. Debe describir con precisin qu incluye y qu se excluye, explicando las razones, y reflejar la realidad operativa del predio. Un alcance bien definido permite delimitar responsabilidades, facilitar la planificacin y asegurar que todas las actividades relevantes estn bajo control.",comoCumplir:" Documentar los lmites del sistema y las actividades cubiertas.  Indicar qu procesos o sedes forman parte del sistema y cules no, con su justificacin.  Verificar que el alcance corresponda a las funciones reales del predio.  Revisarlo y actualizarlo cuando haya cambios en la estructura, los servicios o las operaciones.  Comunicarlo a todo el personal y a las partes interesadas cuando sea necesario.",evidencias:" Documento o declaracin de alcance del sistema integrado.  Mapa de procesos.  Organigrama institucional.  Manual o poltica del sistema.  Actas de revisin o aprobacin del alcance.",criterios:{1:"1: No se ha definido el alcance.",2:"2: Se tiene una idea general sin documento formal.",3:"3: Existe un alcance parcial o sin justificacin de exclusiones.",4:"4: Alcance documentado, aprobado y coherente con las operaciones del predio.",5:"5: Alcance actualizado, validado y comunicado a todo el personal."}},{codigo:"1.4",pregunta:"Existe un sistema integrado de gestin ambiental implementado, documentado y en funcionamiento en el predio?",queImplica:"El sistema integrado de gestin debe estar establecido de manera formal y operando en la prctica. Esto significa que las actividades, procesos y responsabilidades del predio se desarrollan conforme a procedimientos definidos y que existe evidencia del cumplimiento de los requisitos ambientales. No basta con tener documentos; el sistema debe estar aplicado, controlado y en mejora continua.",comoCumplir:" Definir la estructura del sistema, sus responsables y las interacciones entre los procesos.  Mantener la documentacin actualizada (manuales, procedimientos, registros).  Asegurar que los procedimientos se apliquen en las actividades diarias.  Realizar auditoras o revisiones internas para verificar su cumplimiento.  Promover la participacin del personal y comunicar los resultados del sistema a todos los niveles.",evidencias:" Manual o estructura documental del sistema integrado.  Procedimientos y registros operativos.  Informes de auditora interna o revisin por la direccin.  Actas de comits o reuniones de seguimiento.  Registros de capacitacin o comunicacin institucional sobre el sistema.",criterios:{1:"1: No existe sistema documentado ni evidencia de aplicacin.",2:"2: Existen documentos aislados sin aplicacin sistemtica.",3:"3: El sistema est parcialmente implementado o no se aplica en todas las reas.",4:"4: El sistema est documentado, aplicado y con seguimiento regular.",5:"5: El sistema funciona de forma completa, con mejora continua y comunicacin en todos los niveles."}},{codigo:"2.1",pregunta:"La direccin del predio demuestra liderazgo y compromiso con la gestin ambiental, asegurando la integracin del sistema en las actividades institucionales?",queImplica:"La direccin del predio debe liderar con el ejemplo, impulsar la aplicacin del sistema y garantizar que la gestin ambiental est integrada en todas las actividades. Su compromiso se refleja en la asignacin de recursos, la participacin activa en la planificacin, el seguimiento de los resultados y la comunicacin de la importancia del cumplimiento de las polticas y objetivos. Un liderazgo visible fortalece la cultura institucional y el sentido de responsabilidad en todo el equipo.",comoCumplir:" Participar en reuniones, auditoras o revisiones relacionadas con el sistema.  Promover el cumplimiento de polticas, objetivos y compromisos institucionales.  Asignar recursos humanos, tcnicos y financieros suficientes.  Reconocer las buenas prcticas del personal y fomentar la mejora continua.  Mantener comunicacin constante sobre la importancia de la gestin ambiental en las decisiones del predio.",evidencias:" Actas de reuniones o comits donde participe la direccin.  Comunicaciones o mensajes institucionales de apoyo al sistema.  Informes de gestin o revisin por la direccin.  Registros de asignacin de recursos o aprobaciones de proyectos.  Evidencias de participacin en campaas, inspecciones o auditoras.",criterios:{1:"1: No hay evidencia de liderazgo o participacin de la direccin.",2:"2: La direccin conoce el sistema, pero su participacin es limitada.",3:"3: La direccin participa parcialmente o solo ante situaciones puntuales.",4:"4: La direccin demuestra compromiso constante y apoyo al sistema.",5:"5: La direccin lidera activamente, comunica los avances y promueve la mejora continua."}},{codigo:"2.2",pregunta:"Existe una poltica integrada de gestin ambiental aprobada, actualizada, comunicada y disponible para todas las partes interesadas?",queImplica:"La poltica integrada expresa los compromisos del predio con la proteccin del ambiente, la calidad de sus servicios, el cumplimiento de los requisitos legales y la mejora continua. Debe estar aprobada por la direccin, mantenerse actualizada y ser conocida por todo el personal y las partes interesadas. Esta poltica sirve como gua para las decisiones, objetivos y acciones dentro del sistema de gestin.",comoCumplir:" Elaborar la poltica de forma clara, sencilla y coherente con las actividades del predio.  Aprobarla formalmente por la direccin y difundirla mediante medios accesibles (carteleras, correos, reuniones, capacitaciones o pgina web).  Revisarla peridicamente para verificar que sigue siendo adecuada y actual.  Asegurar que todos los trabajadores comprendan su contenido y cmo aplicarla en su labor diaria.",evidencias:" Documento de la poltica firmada y aprobada.  Publicacin en carteleras, sitio web o material institucional.  Registros de capacitacin o socializacin de la poltica.  Comunicaciones oficiales o correos informativos.  Actas de revisin o actualizacin de la poltica.",criterios:{1:"1: No existe poltica formal ni documento aprobado.",2:"2: Existe un borrador o documento antiguo sin aprobacin ni difusin.",3:"3: La poltica est aprobada, pero no se comunica o no est actualizada.",4:"4: La poltica est vigente, aprobada y comunicada al personal del predio.",5:"5: La poltica est actualizada, publicada, comprendida y aplicada por todo el personal y las partes interesadas."}},{codigo:"2.3",pregunta:"Estn definidos, documentados y comunicados los roles, responsabilidades y autoridades del personal del predio (administradores, docentes, operarios) dentro del sistema integrado de gestin ambiental?",queImplica:"La definicin clara de roles y responsabilidades garantiza que cada persona conozca sus funciones dentro del sistema integrado. Esto evita confusiones, facilita la ejecucin de las tareas y asegura que las actividades relacionadas con la gestin ambiental se realicen correctamente. Adems, la autoridad asignada debe ser coherente con las responsabilidades y con el nivel de decisin que cada cargo requiere.",comoCumplir:" Definir las funciones y responsabilidades en documentos formales (manuales, descripciones de cargo o procedimientos).  Comunicar y capacitar al personal sobre su papel dentro del sistema.  Verificar que las autoridades asignadas sean adecuadas para cumplir las tareas.  Actualizar las funciones cuando cambien las estructuras o procesos del predio.  Asegurar que todas las reas estn representadas en el sistema.",evidencias:" Manual de funciones o perfiles de cargo.  Organigrama institucional o del sistema integrado.  Actas o comunicaciones donde se asignen responsabilidades.  Procedimientos que indiquen responsables por actividad.  Registros de capacitaciones o reuniones informativas.",criterios:{1:"1: No existen roles ni responsabilidades definidos.",2:"2: Las funciones existen de manera informal o sin documentacin.",3:"3: Los roles estn definidos pero no comunicados o actualizados.",4:"4: Roles, responsabilidades y autoridades estn documentados, comunicados y aplicados.",5:"5: Roles claramente definidos, revisados peridicamente y comprendidos por todo el personal."}},{codigo:"3.1.1",pregunta:"El predio ha identificado los riesgos y oportunidades que pueden afectar la gestin ambiental, la calidad del servicio y el cumplimiento de los objetivos institucionales?",queImplica:"La identificacin de riesgos y oportunidades permite anticipar situaciones que podran impactar negativa o positivamente la gestin ambiental y la calidad de los servicios. Este anlisis ayuda a planificar acciones preventivas, mejorar la eficiencia y fortalecer el cumplimiento de los objetivos institucionales. Debe contemplar factores internos (operativos, administrativos, de recursos) y externos (sociales, legales, ambientales, tecnolgicos).",comoCumplir:" Realizar una evaluacin sistemtica de riesgos y oportunidades utilizando mtodos adecuados (matrices, listas de verificacin o anlisis FODA).  Involucrar a las diferentes reas del predio en la identificacin de situaciones que afecten sus procesos.  Definir responsables para el seguimiento de las acciones preventivas y de mejora.  Revisar peridicamente los resultados para actualizar la informacin y ajustar las medidas segn los cambios del entorno o la operacin.",evidencias:" Matriz de riesgos y oportunidades del sistema integrado.  Registros de reuniones o talleres de anlisis.  Informes de revisin por la direccin.  Planes de accin o controles implementados.  Evidencias del seguimiento de riesgos (indicadores, auditoras o reportes).",criterios:{1:"1: No se han identificado riesgos ni oportunidades.",2:"2: Se han identificado parcialmente sin metodologa ni seguimiento.",3:"3: Existen registros bsicos, pero no se actualizan ni se vinculan con los objetivos.",4:"4: Riesgos y oportunidades estn documentados, evaluados y con planes de accin definidos.",5:"5: El anlisis se revisa, actualiza y se utiliza activamente para la toma de decisiones y mejora continua."}},{codigo:"3.1.2",pregunta:"Se han identificado, evaluado y actualizado los aspectos ambientales y los procesos o actividades que impactan el desempeo ambiental o la calidad de los servicios del predio?",queImplica:"La identificacin de aspectos ambientales y de los procesos que influyen en la calidad permite reconocer cmo las actividades del predio afectan su desempeo ambiental y los resultados de sus servicios. Este anlisis es clave para controlar impactos negativos, aprovechar oportunidades de mejora y cumplir con los objetivos del sistema. Debe actualizarse cuando cambian las operaciones, equipos o condiciones del entorno.",comoCumplir:" Elaborar un inventario de aspectos ambientales asociados a las actividades del predio (uso de recursos, generacin de residuos, emisiones, consumo de energa, etc.).  Evaluar su significancia considerando criterios como frecuencia, severidad, magnitud y capacidad de control.  Identificar tambin los procesos que influyen directamente en la calidad de los servicios ofrecidos.  Mantener la informacin actualizada y revisar los resultados peridicamente.",evidencias:" Matriz de aspectos e impactos ambientales actualizada.  Registro de procesos crticos relacionados con la calidad.  Procedimientos o instructivos de evaluacin.  Informes de revisin o seguimiento.  Actas de reuniones donde se aprueban actualizaciones o cambios.",criterios:{1:"1: No se han identificado aspectos ni procesos significativos.",2:"2: Identificacin parcial o sin criterios claros de evaluacin.",3:"3: Aspectos y procesos identificados, pero sin actualizacin ni seguimiento.",4:"4: Evaluacin completa y actualizada, con criterios documentados y responsables definidos.",5:"5: Sistema consolidado y revisado regularmente, con evidencias de control, mejora y comunicacin al personal."}},{codigo:"3.1.3",pregunta:"Se han determinado, actualizado y comunicado los requisitos legales, normativos y otros requisitos aplicables a la gestin ambiental?",queImplica:"El cumplimiento de los requisitos legales y normativos es esencial para garantizar que las actividades del predio se desarrollen dentro del marco regulatorio vigente. Este proceso implica identificar, evaluar, actualizar y comunicar todas las leyes, decretos, normas tcnicas y compromisos voluntarios que afecten la gestin ambiental y la calidad de los servicios.",comoCumplir:" Establecer un procedimiento para la identificacin y actualizacin de los requisitos legales y otros compromisos aplicables.  Asignar responsables para el seguimiento de cambios normativos y mantener un registro actualizado.  Verificar el cumplimiento mediante auditoras internas o revisiones peridicas.  Asegurar que las reas involucradas conozcan las obligaciones que les corresponden.",evidencias:" Matriz de requisitos legales y normativos vigente.  Registros de actualizacin normativa.  Actas o comunicaciones de socializacin de cambios legales.  Informes de evaluacin del cumplimiento.  Procedimiento documentado de identificacin y seguimiento legal.",criterios:{1:"1: No se han identificado requisitos legales o normativos aplicables.",2:"2: Existen referencias parciales o sin actualizacin.",3:"3: Se tiene una matriz o registro, pero sin evidencia de comunicacin ni seguimiento.",4:"4: Los requisitos estn identificados, actualizados y comunicados a las reas pertinentes.",5:"5: Sistema formal de gestin legal implementado, con revisin peridica y evidencia de cumplimiento continuo."}},{codigo:"3.1.4",pregunta:"Se han definido e implementado acciones para abordar los riesgos, oportunidades y aspectos significativos identificados en el sistema integrado de gestin ambiental?",queImplica:"Una vez identificados los riesgos, oportunidades y aspectos significativos, el predio debe planificar e implementar acciones que permitan prevenir efectos negativos, aprovechar oportunidades de mejora y fortalecer la gestin ambiental. Estas acciones deben integrarse en los procesos operativos, ser coherentes con los objetivos institucionales y evaluarse en trminos de eficacia.",comoCumplir:" Establecer planes de accin especficos con responsables, recursos y plazos definidos, priorizando segn nivel de riesgo o significancia.  Incluir medidas preventivas, correctivas y de mejora continua.  Hacer seguimiento a la ejecucin y evaluar los resultados para asegurar que las acciones sean eficaces y sostenibles.  Comunicar los avances a las partes involucradas.",evidencias:" Planes de accin documentados y aprobados.  Registros de seguimiento o evaluacin de las acciones.  Informes de revisin por la direccin.  Evidencias de implementacin (fotografas, actas, reportes).  Indicadores de cumplimiento o mejora.",criterios:{1:"1: No se han definido acciones para abordar riesgos u oportunidades.",2:"2: Existen acciones identificadas, pero sin planificacin ni seguimiento.",3:"3: Hay planes definidos, pero sin evidencia clara de implementacin o resultados.",4:"4: Las acciones estn implementadas, documentadas y con seguimiento parcial.",5:"5: Las acciones estn completamente integradas, evaluadas y evidencian mejoras sostenibles."}},{codigo:"3.2.1",pregunta:"Existen objetivos de gestin ambiental documentados, medibles y coherentes con la poltica institucional?",queImplica:"Los objetivos permiten orientar los esfuerzos del predio hacia la mejora del desempeo ambiental y de la calidad de los servicios. Deben ser claros, medibles, alcanzables, relevantes y coherentes con la poltica institucional. Su formulacin y seguimiento garantizan que el sistema de gestin se traduzca en resultados concretos y verificables.",comoCumplir:" Definir objetivos especficos para las reas ms relevantes del predio (por ejemplo: reduccin de consumo de agua, mejora en la satisfaccin de usuarios, control de residuos).  Establecer indicadores que permitan medir el avance.  Asegurar que los objetivos estn documentados, aprobados por la direccin y comunicados a todo el personal.  Revisarlos peridicamente y actualizarlos segn los resultados o cambios en las condiciones operativas.",evidencias:" Listado o matriz de objetivos ambientales.  Indicadores de seguimiento y resultados.  Actas de aprobacin por la direccin.  Informes de cumplimiento.  Evidencias de comunicacin o difusin de los objetivos.",criterios:{1:"1: No existen objetivos definidos.",2:"2: Existen objetivos generales, pero no son medibles ni documentados.",3:"3: Objetivos definidos, pero sin indicadores o sin seguimiento formal.",4:"4: Objetivos documentados, medibles y con evidencia de seguimiento.",5:"5: Objetivos revisados peridicamente, alcanzados o ajustados segn resultados, alineados con la poltica institucional."}},{codigo:"3.2.2",pregunta:"Se han establecido y ejecutado planes de accin con responsables, recursos y plazos para cumplir los objetivos de gestin ambiental?",queImplica:"Los planes de accin son la herramienta que convierte los objetivos en actividades concretas y medibles. Permiten organizar los recursos, asignar responsabilidades y definir plazos para alcanzar los resultados esperados en la gestin ambiental. Su correcta ejecucin garantiza que los compromisos institucionales se traduzcan en mejoras reales dentro del predio.",comoCumplir:" Elaborar planes de accin para cada objetivo definido, incluyendo actividades especficas, responsables, cronogramas, recursos requeridos y mtodos de evaluacin.  Hacer seguimiento al cumplimiento de cada accin y actualizar los planes segn los resultados obtenidos o las condiciones operativas.  Asegurar la participacin del personal responsable y la comunicacin de los avances a la direccin.",evidencias:" Planes de accin documentados y aprobados.  Registros de seguimiento o cumplimiento.  Informes de avance y resultados.  Actas de reuniones de seguimiento.  Indicadores asociados a los objetivos.  Evidencia de uso de recursos y asignacin de responsables.",criterios:{1:"1: No existen planes de accin definidos.",2:"2: Planes elaborados parcialmente o sin responsables claros.",3:"3: Planes definidos, pero sin evidencia de ejecucin o seguimiento.",4:"4: Planes ejecutados con registros de cumplimiento y revisin.",5:"5: Planes actualizados, ejecutados en su totalidad y evaluados por la direccin, con resultados documentados y mejoras demostrables."}},{codigo:"4.1",pregunta:"El predio cuenta con los recursos humanos, tcnicos, financieros e infraestructura necesarios para la gestin ambiental?",queImplica:"Disponer de los recursos adecuados es fundamental para garantizar el funcionamiento efectivo del sistema de gestin ambiental. Esto incluye contar con personal suficiente y competente, infraestructura en buenas condiciones, equipos funcionales y recursos financieros que permitan ejecutar las actividades planificadas y cumplir los objetivos establecidos.",comoCumplir:" Identificar las necesidades de recursos segn los procesos del predio y planificarlas dentro del presupuesto institucional.  Asegurar que los equipos, herramientas e instalaciones estn disponibles, mantenidos y en condiciones ptimas.  Asignar personal suficiente y capacitado para ejecutar las tareas del sistema.  Revisar peridicamente la disponibilidad de recursos y gestionar ajustes cuando sea necesario.",evidencias:" Plan de recursos o presupuesto anual.  Registros de mantenimiento y calibracin de equipos.  Inventarios de infraestructura y herramientas.  Actas de asignacin de recursos.  Informes de revisin por la direccin.  Evidencias fotogrficas o documentales de adecuaciones y mejoras.",criterios:{1:"1: No existen recursos identificados ni disponibles.",2:"2: Se dispone de algunos recursos, pero son insuficientes o inadecuados.",3:"3: Recursos definidos, pero con limitaciones de disponibilidad o mantenimiento.",4:"4: Recursos suficientes, asignados y utilizados de forma adecuada.",5:"5: Recursos plenamente disponibles, gestionados eficientemente y revisados peridicamente para garantizar la mejora continua."}},{codigo:"4.2",pregunta:"El personal cuenta con las competencias, conocimientos y capacitaciones necesarias para realizar sus funciones relacionadas con la gestin ambiental?",queImplica:"La competencia del personal es un elemento clave para asegurar la correcta implementacin y mantenimiento del sistema de gestin ambiental. Implica que cada persona conozca sus funciones, cuente con la formacin adecuada y posea las habilidades necesarias para cumplir con los requisitos del sistema y los objetivos institucionales.",comoCumplir:" Definir las competencias requeridas para cada cargo o funcin vinculada al sistema.  Evaluar peridicamente el nivel de conocimiento del personal y las necesidades de capacitacin.  Desarrollar programas de formacin y sensibilizacin sobre temas ambientales, seguridad y mejora continua.  Registrar la participacin en capacitaciones y verificar la aplicacin prctica de lo aprendido en las actividades cotidianas.",evidencias:" Matriz de competencias del personal.  Registros de asistencia a capacitaciones y evaluaciones.  Plan anual de formacin.  Manual de funciones o perfiles de cargo.  Actas de reuniones o talleres.  Certificados de cursos o entrenamientos realizados.",criterios:{1:"1: No se han definido competencias ni realizado capacitaciones.",2:"2: Competencias identificadas parcialmente o sin registros de formacin.",3:"3: Existen capacitaciones puntuales, pero sin evaluacin ni seguimiento.",4:"4: Competencias definidas y formacin planificada, con evidencia de aplicacin.",5:"5: Sistema de formacin y evaluacin consolidado, actualizado y alineado con los objetivos del sistema."}},{codigo:"4.3",pregunta:"Se promueve la concientizacin y sensibilizacin sobre la gestin ambiental entre estudiantes, docentes y trabajadores?",queImplica:"La concientizacin y sensibilizacin fortalecen la cultura institucional hacia la sostenibilidad, la calidad y la mejora continua. Implica que toda la comunidad del predio no solo el personal responsable del sistema conozca la importancia de su participacin en la gestin ambiental, comprendiendo cmo sus acciones contribuyen al cumplimiento de los objetivos institucionales y a la proteccin del entorno.",comoCumplir:" Desarrollar campaas, jornadas y actividades educativas que fomenten la responsabilidad ambiental y la mejora del servicio.  Integrar temas de gestin ambiental en las capacitaciones, inducciones y reuniones.  Comunicar de manera accesible los logros, buenas prcticas y resultados del sistema.  Promover la participacin activa de estudiantes, docentes y trabajadores en programas ambientales.",evidencias:" Registros de campaas de sensibilizacin y actividades educativas.  Materiales de comunicacin (afiches, boletines, videos, correos institucionales).  Actas o informes de jornadas ambientales.  Encuestas o evidencias de participacin.  Fotografas y publicaciones en medios institucionales.",criterios:{1:"1: No se realizan actividades de sensibilizacin ni comunicacin.",2:"2: Existen iniciativas aisladas sin continuidad ni registro.",3:"3: Se promueven algunas actividades, pero sin planificacin ni seguimiento.",4:"4: Se realizan campaas y jornadas peridicas, con participacin activa del personal.",5:"5: Existe una cultura consolidada de concientizacin y participacin, con evidencia de mejora y compromiso institucional."}},{codigo:"4.4",pregunta:"Existe comunicacin interna y externa eficaz sobre los temas de gestin ambiental (campaas, informes, circulares, reuniones, reportes)?",queImplica:"La comunicacin eficaz es esencial para garantizar que la informacin relacionada con la gestin ambiental sea comprendida, compartida y aplicada correctamente. Incluye tanto la comunicacin interna entre los diferentes niveles y reas del predio, como la comunicacin externa con partes interesadas (autoridades, comunidad, proveedores, entre otros). Una buena comunicacin fortalece la transparencia, la participacin y el compromiso institucional.",comoCumplir:" Establecer canales formales de comunicacin (correos institucionales, carteleras, reuniones, boletines o plataformas digitales).  Definir qu informacin se comunica, a quin, cundo y por qu medio.  Asegurar que los mensajes sean claros y lleguen a todas las partes interesadas.  Promover la retroalimentacin y el registro de las comunicaciones ms importantes.  Publicar informes, campaas o resultados del sistema en medios accesibles y actualizados.",evidencias:" Registros de comunicaciones internas (correos, actas, boletines, carteleras).  Informes de gestin o reportes de resultados.  Publicaciones institucionales o comunicados oficiales.  Registros de reuniones o socializaciones.  Procedimiento de comunicacin documentado.",criterios:{1:"1: No existen mecanismos formales de comunicacin.",2:"2: La comunicacin es espordica o depende de iniciativas individuales.",3:"3: Existen canales establecidos, pero sin planificacin ni registro.",4:"4: Comunicacin interna y externa estructurada, con evidencia documental y participacin activa.",5:"5: Sistema de comunicacin consolidado, con seguimiento, retroalimentacin y actualizacin continua."}},{codigo:"4.5",pregunta:"Se mantienen actualizados y controlados los documentos y registros del sistema de gestin ambiental (formatos, procedimientos, informes, manuales)?",queImplica:"El control de documentos y registros garantiza la trazabilidad, coherencia y confiabilidad de la informacin del sistema de gestin. Implica que todos los documentos (manuales, procedimientos, formatos e informes) estn actualizados, aprobados, disponibles en su versin vigente y protegidos contra prdida o uso no autorizado. Los registros, por su parte, deben conservarse de manera organizada para evidenciar el cumplimiento de los requisitos y actividades del sistema.",comoCumplir:" Establecer un procedimiento formal para la creacin, revisin, aprobacin, distribucin y control de documentos.  Identificar claramente las versiones vigentes y asegurar que los documentos obsoletos se retiren o marquen adecuadamente.  Mantener registros accesibles, legibles y protegidos.  Revisar peridicamente la documentacin para garantizar su vigencia.  Implementar herramientas digitales o archivos fsicos organizados segn las necesidades del predio.",evidencias:" Procedimiento de control documental.  Listado maestro de documentos y registros.  Versiones controladas de manuales, procedimientos y formatos.  Evidencia de revisin o actualizacin.  Archivos digitales o fsicos organizados.  Registros de auditoras o revisiones internas.",criterios:{1:"1: No existe control documental ni registros actualizados.",2:"2: Existen algunos documentos, pero sin control de versiones ni trazabilidad.",3:"3: Se cuenta con documentacin bsica, aunque no se mantiene actualizada o controlada.",4:"4: Documentos y registros actualizados, controlados y disponibles para el personal.",5:"5: Sistema documental consolidado, digitalizado o fsico, con control de versiones, respaldo y revisin peridica."}},{codigo:"5.1",pregunta:"Se controlan las actividades operativas con potencial impacto ambiental o que puedan afectar la calidad del servicio (uso de maquinaria, agroqumicos, gestin de residuos, mantenimiento, etc.)?",queImplica:"El control operacional busca asegurar que las actividades que puedan generar impactos ambientales o afectar la calidad del servicio se realicen bajo condiciones planificadas y controladas. Esto permite prevenir daos, optimizar recursos, mantener la coherencia con los objetivos del sistema y cumplir con los requisitos legales y normativos aplicables.",comoCumplir:" Identificar las actividades crticas que requieren control (uso de maquinaria, manejo de residuos, consumo de energa, procesos de mantenimiento o atencin al usuario).  Establecer procedimientos, instructivos o rutinas operativas que definan cmo deben realizarse.  Capacitar al personal involucrado y verificar peridicamente el cumplimiento de los controles.  Implementar registros, listas de chequeo o monitoreos que evidencien la ejecucin adecuada de las actividades.",evidencias:" Procedimientos operativos o instructivos documentados.  Registros de mantenimiento, control de residuos y uso de equipos.  Listas de chequeo o formularios de verificacin.  Informes de inspeccin o monitoreo.  Registros fotogrficos o reportes de cumplimiento.",criterios:{1:"1: No se controlan las actividades operativas con potencial impacto.",2:"2: Existen controles informales o no documentados.",3:"3: Algunos procesos estn controlados, pero sin seguimiento ni registros.",4:"4: Actividades operativas controladas mediante procedimientos y evidencias verificables.",5:"5: Controles operativos integrados, revisados peridicamente y con resultados demostrables de mejora."}},{codigo:"5.2",pregunta:"Existen y se aplican protocolos de respuesta ante emergencias ambientales o de operacin (derrames, incendios, escapes de gas, fallas de equipos, interrupciones del servicio, etc.)?",queImplica:"La preparacin y respuesta ante emergencias es fundamental para prevenir daos a las personas, al ambiente y a la infraestructura, as como para garantizar la continuidad de las operaciones. El predio debe contar con procedimientos claros, personal capacitado y recursos disponibles para responder de manera eficaz ante situaciones imprevistas que puedan afectar la gestin ambiental o la calidad del servicio.",comoCumplir:" Identificar los posibles escenarios de emergencia asociados a las actividades del predio.  Elaborar protocolos o planes de emergencia que definan las acciones a seguir, los responsables, los recursos y las rutas de evacuacin.  Capacitar al personal y realizar simulacros peridicos.  Revisar y actualizar los planes segn los resultados de los ejercicios, cambios en las operaciones o nuevas condiciones del entorno.",evidencias:" Plan o procedimiento de emergencias actualizado.  Registros de simulacros o capacitaciones.  Listas de asistencia y evaluaciones de desempeo.  Reportes de incidentes o acciones correctivas.  Sealizacin, kits de emergencia y equipos de seguridad visibles y operativos.",criterios:{1:"1: No existen protocolos ni medidas de respuesta ante emergencias.",2:"2: Existen acciones bsicas, pero sin documentacin ni capacitacin.",3:"3: Protocolos definidos, pero sin simulacros ni evidencia de aplicacin.",4:"4: Protocolos documentados y aplicados con capacitacin y seguimiento peridico.",5:"5: Sistema de gestin de emergencias consolidado, con revisin continua, simulacros regulares y mejora comprobada."}},{codigo:"6.1",pregunta:"Se realiza seguimiento, medicin y monitoreo de los indicadores ambientales (agua, energa, residuos, emisiones, satisfaccin de usuarios, eficiencia de procesos, etc.)?",queImplica:"El seguimiento y medicin de indicadores permite evaluar el desempeo del sistema de gestin ambiental, identificar desviaciones y promover la mejora continua. Implica recopilar, analizar y utilizar datos confiables para tomar decisiones informadas sobre el uso de recursos, el cumplimiento de los objetivos y la eficacia de los procesos.",comoCumplir:" Definir indicadores claros y medibles que reflejen los aspectos ms relevantes del desempeo ambiental.  Establecer una frecuencia de medicin y asignar responsables para la recopilacin y anlisis de los datos.  Registrar los resultados, compararlos con las metas establecidas y comunicar los avances a la direccin y al personal.  Utilizar los resultados para planificar acciones de mejora o correccin.",evidencias:" Matriz o tablero de indicadores.  Registros de medicin (consumo de agua, energa, residuos generados, satisfaccin de usuarios, etc.).  Informes de seguimiento y anlisis de resultados.  Grficos o reportes de tendencias.  Actas de reuniones donde se discuten los resultados.",criterios:{1:"1: No se realiza seguimiento ni medicin de indicadores.",2:"2: Se miden algunos datos sin registros ni anlisis formal.",3:"3: Indicadores definidos, pero sin seguimiento continuo ni comunicacin de resultados.",4:"4: Indicadores medidos peridicamente con anlisis y acciones derivadas.",5:"5: Sistema de monitoreo consolidado, con anlisis comparativo, tendencias y toma de decisiones basada en datos."}},{codigo:"6.2",pregunta:"Se realizan auditoras internas peridicas que evalan el cumplimiento de los requisitos del sistema de gestin ambiental?",queImplica:"Las auditoras internas son una herramienta fundamental para verificar que el sistema de gestin ambiental se implementa de manera eficaz y cumple con los requisitos establecidos. Permiten detectar desviaciones, evaluar el desempeo de los procesos y proponer acciones de mejora antes de las auditoras externas o revisiones de la direccin.",comoCumplir:" Planificar un programa de auditoras internas con una frecuencia definida segn la criticidad de los procesos.  Seleccionar auditores competentes e independientes de las actividades que evalan.  Aplicar listas de verificacin basadas en los requisitos de las normas y procedimientos internos.  Registrar los hallazgos, comunicarlos a los responsables y hacer seguimiento a las acciones correctivas derivadas de las auditoras.",evidencias:" Programa anual de auditoras internas.  Informes o actas de auditoras realizadas.  Listas de chequeo y registros de hallazgos.  Planes de accin correctiva y seguimiento de su cumplimiento.  Registros de capacitacin de auditores internos.",criterios:{1:"1: No se realizan auditoras internas.",2:"2: Se han realizado auditoras espordicas o sin metodologa definida.",3:"3: Auditoras realizadas, pero sin seguimiento a los hallazgos o acciones correctivas.",4:"4: Auditoras planificadas y ejecutadas peridicamente con seguimiento de resultados.",5:"5: Sistema de auditoras consolidado, con anlisis de tendencias, mejora continua y participacin activa de la direccin."}},{codigo:"6.3",pregunta:"La direccin revisa peridicamente el desempeo del sistema de gestin ambiental, tomando decisiones basadas en los resultados de auditoras y monitoreos?",queImplica:"La revisin por la direccin asegura que los responsables institucionales evalen peridicamente la eficacia del sistema de gestin, identifiquen oportunidades de mejora y tomen decisiones informadas. Este proceso garantiza la alineacin del sistema con los objetivos estratgicos, los requisitos legales y las necesidades de las partes interesadas.",comoCumplir:" Programar reuniones de revisin por la direccin al menos una vez al ao o cuando sea necesario.  Analizar resultados de auditoras, indicadores, incidentes, quejas, cumplimiento legal y avances de los objetivos.  Registrar conclusiones, decisiones y acciones derivadas.  Hacer seguimiento a los compromisos para evidenciar la mejora continua.",evidencias:" Actas o informes de revisin por la direccin.  Listas de verificacin o presentaciones utilizadas.  Registros de decisiones y planes de accin.  Informes de seguimiento de acciones correctivas.  Comunicaciones oficiales o aprobaciones derivadas de la revisin.",criterios:{1:"1: No se realiza revisin por la direccin.",2:"2: Se realizan reuniones informales sin registro ni seguimiento.",3:"3: La revisin se hace espordicamente o sin analizar toda la informacin del sistema.",4:"4: Revisin documentada, con anlisis de resultados y decisiones tomadas.",5:"5: Revisin peridica, documentada y con evidencia de decisiones estratgicas que impulsan la mejora continua."}},{codigo:"7.1",pregunta:"Se gestionan adecuadamente las no conformidades y desviaciones del sistema de gestin ambiental (por ejemplo, incumplimientos de permisos, manejo de residuos, fallas en procesos o servicios)?",queImplica:"La gestin de no conformidades permite identificar, registrar y corregir los incumplimientos o fallas que afectan el desempeo ambiental o la calidad de los servicios. Un tratamiento adecuado de estas situaciones ayuda a prevenir su repeticin, mejorar los procesos y fortalecer la eficacia del sistema de gestin.",comoCumplir:" Establecer un procedimiento formal para la identificacin, registro, anlisis y correccin de no conformidades.  Incluir la investigacin de causas y la definicin de acciones correctivas apropiadas.  Asegurar que las no conformidades se documenten y que se haga seguimiento a su cierre y efectividad.  Comunicar los resultados a las partes responsables y analizar tendencias para prevenir recurrencias.",evidencias:" Registros de no conformidades o desviaciones.  Formularios o reportes de anlisis de causa raz.  Planes de accin correctiva.  Registros de verificacin de cierre.  Informes de auditoras internas y revisiones por la direccin.",criterios:{1:"1: No se gestionan las no conformidades ni se registran.",2:"2: Se identifican algunas no conformidades, pero sin registro ni seguimiento formal.",3:"3: Se documentan las no conformidades, pero sin anlisis de causas o acciones efectivas.",4:"4: No conformidades gestionadas mediante procedimientos documentados y seguimiento parcial.",5:"5: Sistema consolidado de gestin de no conformidades con anlisis de causas, acciones efectivas y mejora continua."}},{codigo:"7.2",pregunta:"Se aplican, documentan y evalan acciones correctivas y de mejora continua para garantizar la eficacia del sistema de gestin ambiental?",queImplica:"La aplicacin de acciones correctivas y de mejora continua asegura que el sistema de gestin evolucione y mantenga su eficacia con el tiempo. Las acciones correctivas eliminan las causas de las no conformidades detectadas, mientras que la mejora continua busca optimizar los procesos, aumentar la satisfaccin de las partes interesadas y fortalecer el desempeo ambiental.",comoCumplir:" Implementar un procedimiento para identificar oportunidades de mejora y gestionar las acciones correctivas derivadas de auditoras, revisiones o incidentes.  Documentar cada accin, sus responsables, plazos y resultados esperados.  Verificar la eficacia de las acciones mediante evaluaciones, seguimiento de indicadores o auditoras internas.  Promover la participacin del personal en la identificacin de mejoras y registrar las iniciativas exitosas.",evidencias:" Registros de acciones correctivas y de mejora.  Planes de accin con responsables y fechas.  Informes de seguimiento o cierre.  Actas de reuniones de mejora.  Registros de auditoras o revisiones de direccin.  Indicadores de desempeo que reflejen avances.",criterios:{1:"1: No se aplican acciones correctivas ni actividades de mejora.",2:"2: Se aplican algunas acciones, pero sin documentacin ni seguimiento.",3:"3: Existen registros de acciones correctivas, pero sin evaluacin de su eficacia.",4:"4: Acciones correctivas y de mejora documentadas, implementadas y con seguimiento regular.",5:"5: Sistema de mejora continua consolidado, con evaluacin sistemtica, resultados medibles y participacin activa del personal."}}];function Bn(r,e=cr){if(!r)return;let t=document.querySelector(".tooltip-card.__shared");t||(t=document.createElement("div"),t.className="tooltip-card __shared",document.body.appendChild(t));let s=null;const i=c=>{const l=(u,f)=>f?`<div class="tooltip-section"><b>${u}</b><div>${Oe(f)}</div></div>`:"",d=(u,f)=>{if(!f)return"";if(typeof f=="object"&&!Array.isArray(f)){const v=Object.entries(f).sort(([E],[_])=>String(E).localeCompare(String(_))).map(([,E])=>`<li>${Oe(E)}</li>`).join("");return`<div class="tooltip-section"><b>${u}</b><ul>${v}</ul></div>`}const p=String(f).split(/\r?\n|;|/).map(g=>g.trim()).filter(Boolean);return p.length>=2?`<div class="tooltip-section"><b>${u}</b><ul>${p.map(g=>`<li>${Oe(g)}</li>`).join("")}</ul></div>`:l(u,String(f))},h=c!=null&&c.sugerencias?`<div class="tooltip-section"><b>Sugerencias</b><div class="tooltip-grid">${Object.entries(c.sugerencias).map(([u,f])=>`<div><b>${Oe(u)}:</b> <span>${Oe(f)}</span></div>`).join("")}</div></div>`:"";return`
      ${l("Qu implica",c.queImplica)}
      ${l("Cmo cumplir",c.comoCumplir)}
      ${l("Evidencias",c.evidencias)}
      ${d("Criterios",c.criterios)}
      ${h}
    `};t.addEventListener("mouseenter",()=>{s&&(clearTimeout(s),s=null)}),t.addEventListener("mouseleave",()=>n());function n(){s&&clearTimeout(s),s=setTimeout(()=>{t.classList.remove("visible")},220)}function a(c,l,d){t.innerHTML=c;const h=12;let u=l.right+h,f=l.top;const p=t.getBoundingClientRect(),g=window.innerWidth,v=window.innerHeight;u+p.width>g-10&&(u=Math.max(10,l.left-p.width-h)),f+p.height>v-10&&d&&(f=Math.max(10,d.bottom-p.height)),f<10&&(f=10),u<10&&(u=10),t.style.left=u+"px",t.style.top=f+"px",t.offsetHeight,t.classList.add("visible")}function o(c){var f,p;const l=(f=c.dataset.codigo)==null?void 0:f.trim(),d=(p=c.dataset.pregunta)==null?void 0:p.trim(),h=e.find(g=>g.codigo===l)||e.find(g=>!!d&&g.pregunta&&d.startsWith(g.pregunta.slice(0,18)));if(!h)return;let u=c.querySelector(".help-icon");if(!u){const g=c.querySelector("strong")||c.firstElementChild;u=document.createElement("span"),u.className="help-icon",u.setAttribute("title","Ayuda"),u.textContent="",g&&g.parentNode?g.parentNode.insertBefore(u,g.nextSibling):c.insertBefore(u,c.firstChild)}u.addEventListener("mouseenter",()=>{s&&(clearTimeout(s),s=null);const g=u.getBoundingClientRect(),v=c.getBoundingClientRect();a(i(h),g,v)}),u.addEventListener("mouseleave",()=>n())}r.querySelectorAll(".question-card").forEach(o)}function Oe(r){return r==null?"":String(r).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}async function zn(r="#app-question"){var v,E,_;const e=typeof r=="string"?document.querySelector(r):r;if(!e)return;e.innerHTML="";const t=document.createElement("div");t.className="card";const s=document.createElement("h3");s.textContent="Responder preguntas de evaluacin",t.appendChild(s);const i=document.createElement("div");i.className="small",i.textContent='Complete una calificacin y/o observacin por cada pregunta y presione "Enviar todas"',t.appendChild(i);const n=document.createElement("div");n.className="form-row";let a=[];try{const{data:m,error:b}=await N.from("predios").select("*").order("id",{ascending:!0});if(b)throw b;a=m||[]}catch(m){console.error("Error cargando predios:",m)}const o=document.createElement("div");o.className="field-group";const c=document.createElement("label");c.className="field-label",c.textContent="Predio a evaluar",c.htmlFor="predioSelect";const l=document.createElement("select");l.className="input-select select-predio",l.id="predioSelect";const d=document.createElement("option");if(d.value="",d.textContent="Selecciona un predio...",d.disabled=!0,d.selected=!0,l.appendChild(d),a.length>0)a.forEach(m=>{const b=m.nombre??m.name??m.predio??m.titulo??String(m.id),T=document.createElement("option");T.value=String(m.id),T.textContent=b,l.appendChild(T)});else{const m=document.createElement("option");m.value="1",m.textContent="Predio 1",l.appendChild(m)}o.appendChild(c),o.appendChild(l);const h=document.createElement("div");h.className="input-flex small",h.textContent="Evaluador: (no autenticado)",n.appendChild(o),n.appendChild(h),t.appendChild(n);const u=document.createElement("div");u.className="questions-grid",t.appendChild(u);const f=document.createElement("button");f.className="btn btn-margin",f.textContent="Enviar todas las respuestas",t.appendChild(f);const p=document.createElement("div");p.className="small",t.appendChild(p),e.appendChild(t);let g=[];try{const{data:m,error:b}=await N.from("preguntas").select("*").order("id",{ascending:!0});if(b)throw b;g=m||[]}catch(m){console.error("Error cargando preguntas:",m),p.textContent="Error cargando preguntas: "+(m.message||m);return}g.forEach(m=>{const b=document.createElement("div");b.className="card question-card",m.codigo&&(b.dataset.codigo=String(m.codigo)),m.pregunta&&(b.dataset.pregunta=String(m.pregunta));const T=document.createElement("div");T.innerHTML=`<strong>${m.codigo||""} ${m.titulo_clausula||""}</strong>`;const A=document.createElement("p");A.textContent=m.pregunta||"";const P=document.createElement("div");P.textContent=`Calificacin (${m.min_valor??1} - ${m.max_valor??5})`;const D=document.createElement("div");D.className="radio-group";const U=Number(m.min_valor??1),Z=Number(m.max_valor??5);for(let $=U;$<=Z;$++){const y=`preg-${m.id}-val-${$}`,w=document.createElement("label");w.className="radio-label";const O=document.createElement("input");O.type="radio",O.name=`pregunta-${m.id}`,O.value=String($),O.id=y,O.dataset.preguntaId=String(m.id),O.className="input-radio",$===U&&(O.checked=!0);const R=document.createElement("span");R.textContent=String($),w.appendChild(O),w.appendChild(R),D.appendChild(w)}const z=document.createElement("textarea");z.rows=2,z.className="textarea-full",z.placeholder="Observacin (opcional)",z.dataset.preguntaId=String(m.id),b.appendChild(T),b.appendChild(A),b.appendChild(P),b.appendChild(D),b.appendChild(z),u.appendChild(b)});try{Bn(u,cr)}catch(m){console.warn("No se pudieron aplicar tooltips:",m)}try{const m=await N.auth.getSession(),b=((_=(E=(v=m==null?void 0:m.data)==null?void 0:v.session)==null?void 0:E.user)==null?void 0:_.email)||null;b&&(h.textContent=`Evaluador: ${b}`)}catch(m){console.warn("No se pudo obtener sesin:",m)}f.addEventListener("click",async()=>{var D,U,Z;if(!l.value){p.textContent="Selecciona un predio para continuar.";return}const m=Number(l.value);let b=null;try{const z=await N.auth.getSession();b=((Z=(U=(D=z==null?void 0:z.data)==null?void 0:D.session)==null?void 0:U.user)==null?void 0:Z.email)||null}catch{b=null}const T=[],A=u.querySelectorAll('input[type="radio"][data-pregunta-id]'),P=new Set;for(const z of A){const $=Number(z.dataset.preguntaId);if(P.has($))continue;const y=u.querySelector(`input[type="radio"][data-pregunta-id="${$}"]:checked`),w=g.find(J=>Number(J.id)===$);if(!w)continue;const O=Number(y?y.value:w.min_valor??1),R=u.querySelector(`textarea[data-pregunta-id="${$}"]`),V=R&&R.value.trim()||null;T.push({predio_id:m,pregunta_id:$,valor:O,observacion:V,evaluador:b,fecha:new Date().toISOString()}),P.add($)}if(T.length===0){p.textContent="No hay respuestas para enviar.";return}p.textContent="Preparando envo de "+T.length+" respuestas...",f.disabled=!0;try{const z=[...new Set(T.map(j=>j.pregunta_id))];p.textContent="Comparando respuestas existentes...";const{data:$,error:y}=await N.from("respuestas").select("id,predio_id,pregunta_id,valor,observacion").eq("predio_id",m).in("pregunta_id",z).order("id",{ascending:!1});y&&console.warn("No se pudieron consultar respuestas previas:",y.message||y);const w=new Map;if(Array.isArray($))for(const j of $){const B=Number(j.pregunta_id);w.has(B)||w.set(B,j)}const O=[],R=[];let V=0;for(const j of T){const B=w.get(Number(j.pregunta_id));if(!B)O.push(j);else{const ee=Number(B.valor),Qe=B.observacion??null,Ce=Number(j.valor),At=j.observacion??null;ee!==Ce||Qe!==At?R.push({id:B.id,valor:Ce,observacion:At,evaluador:j.evaluador,fecha:j.fecha}):V++}}let J=0,ue=0;if(O.length){p.textContent=`Insertando ${O.length} nuevas respuestas...`;const{data:j,error:B}=await N.from("respuestas").insert(O).select("id");if(B){console.error(B),p.textContent="Error al insertar: "+(B.message||B),f.disabled=!1;return}J=(j==null?void 0:j.length)??O.length}if(R.length){p.textContent=`Actualizando ${R.length} respuestas cambiadas...`;for(const j of R){const{error:B}=await N.from("respuestas").update({valor:j.valor,observacion:j.observacion,evaluador:j.evaluador,fecha:j.fecha}).eq("id",j.id);B?console.warn("No se pudo actualizar id",j.id,B.message||B):ue++}}p.textContent=`Cambios aplicados  Insertadas: ${J}, Actualizadas: ${ue}, Sin cambios: ${V}`;try{const j=u.querySelectorAll('input[type="radio"][data-pregunta-id]');for(const ee of j)ee.checked=!1;for(const ee of g){const Qe=String(ee.min_valor??1),Ce=u.querySelector(`input[type="radio"][data-pregunta-id="${ee.id}"][value="${Qe}"]`);Ce&&(Ce.checked=!0)}const B=u.querySelectorAll("textarea");for(const ee of B)ee.value="";p.textContent="Formulario reiniciado."}catch(j){console.error("No se pudo resetear el formulario:",j)}try{document.querySelector("#app-respuestas")&&await lr("#app-respuestas")}catch(j){console.warn("No se pudo refrescar la tabla de respuestas:",(j==null?void 0:j.message)||j)}try{document.querySelector("#app-progress")&&await dr("#app-progress")}catch(j){console.warn("No se pudo refrescar el progreso por predio:",(j==null?void 0:j.message)||j)}}catch(z){console.error(z),p.textContent="Error inesperado al enviar."}f.disabled=!1})}async function lr(r="#app"){const e=typeof r=="string"?document.querySelector(r):r;if(!e)throw new Error("Elemento root no encontrado: "+r);e.innerHTML="";const t=document.createElement("div");t.className="card dashboard-main";const s=document.createElement("h2");s.textContent="Respuestas  public.respuestas",t.appendChild(s);const i=document.createElement("div");i.id="respuestasStatus",i.className="small",i.textContent="Cargando respuestas...",t.appendChild(i);const n=document.createElement("table");n.id="respuestasTable";const a=document.createElement("thead"),o=document.createElement("tr"),c=["idx","id","predio_id","pregunta_id","valor","observacion","evaluador","fecha"];c.forEach(f=>{const p=document.createElement("th");p.textContent=f,o.appendChild(p)}),a.appendChild(o),n.appendChild(a);const l=document.createElement("tbody");n.appendChild(l),t.appendChild(n);const d=document.createElement("div");d.className="form-row";const h=document.createElement("button");h.className="btn btn-secondary",h.textContent="Recargar respuestas",h.addEventListener("click",()=>u()),d.appendChild(h),t.appendChild(d),e.appendChild(t);async function u(){i.textContent="Consultando base de datos...",l.innerHTML="";try{const{data:f,error:p}=await N.from("respuestas").select("*").order("id",{ascending:!0});if(p){console.error("Error supabase:",p),i.textContent="Error al obtener respuestas: "+(p.message||p);return}if(!f||f.length===0){i.textContent="No se encontraron respuestas.";return}for(const g of f){const v=document.createElement("tr");c.forEach(E=>{const _=document.createElement("td");let m=g[E];if(E==="fecha"&&m){const b=new Date(m);isNaN(b)||(m=b.toLocaleString())}_.textContent=m==null?"":String(m),v.appendChild(_)}),l.appendChild(v)}i.textContent="Cargadas "+f.length+" respuestas."}catch(f){console.error("Error inesperado:",f),i.textContent="Error inesperado al cargar respuestas."}}await u()}async function dr(r="#app-progress"){const e=typeof r=="string"?document.querySelector(r):r;if(!e)return;e.innerHTML="";const t=document.createElement("div");t.className="card";const s=document.createElement("div");s.className="card";const i=document.createElement("h3");i.textContent="Cobertura de evaluacin",s.appendChild(i);const n=document.createElement("div");n.className="small",n.textContent="Porcentaje de predios evaluados completamente (todas las preguntas respondidas).",s.appendChild(n),s.style.marginBottom="24px";let a=[];try{const{data:y,error:w}=await N.from("preguntas").select("id");if(w)throw w;a=y||[]}catch(y){console.error("Error cargando preguntas:",y),s.appendChild(document.createTextNode("Error cargando preguntas.")),e.appendChild(s);return}const o=a.length||0;if(o===0){const y=document.createElement("div");y.textContent="No hay preguntas registradas.",s.appendChild(y),e.appendChild(s);return}let c=[];try{const{data:y,error:w}=await N.from("respuestas").select("*");if(w)throw w;c=y||[]}catch(y){console.error("Error cargando respuestas:",y),s.appendChild(document.createTextNode("Error cargando respuestas.")),e.appendChild(s);return}let l=[],d=0;try{const{data:y,error:w}=await N.from("predios").select("id,nombre").order("id",{ascending:!0});if(w)throw w;l=y||[];const{count:O}=await N.from("predios").select("*",{count:"exact",head:!0});d=Number(O||0)}catch(y){console.warn("No se pudo obtener la lista completa de predios:",y)}const h=new Map,u=new Map;for(const y of c){const w=String((y.predio_id??y.predio)||"unknown"),O=h.get(w)||{total:0,total5:0};O.total+=1,Number(y.valor)===5&&(O.total5+=1),h.set(w,O);const R=u.get(w)||new Set;y.pregunta_id!=null&&R.add(Number(y.pregunta_id)),u.set(w,R)}const f=new Map;if(l.length)for(const y of l){const w=String(y.id),O=y.nombre??y.name??y.predio??y.titulo??y.codigo??`Predio ${y.id}`;f.set(w,O)}else try{const y=Array.from(h.keys()).filter(w=>w!=="unknown").map(w=>Number(w)).filter(w=>!Number.isNaN(w));if(y.length){const{data:w,error:O}=await N.from("predios").select("id,nombre").in("id",y);if(!O&&w)for(const R of w){const V=String(R.id),J=R.nombre??R.name??R.predio??R.titulo??R.codigo??null;J&&f.set(V,J)}}}catch(y){console.warn("No se pudo obtener nombres de predios:",y)}const p=l.length||d||f.size||0;let g=0;const v=[];if(p>0)if(l.length){const y=l.map(w=>String(w.id));for(const w of y){const O=u.get(w)||new Set;if(O.size>=o)g+=1;else{const R=f.get(w)||(w==="unknown"?"Predio desconocido":`Predio ${w}`);v.push({pid:w,label:R,estado:O.size===0?"sin respuestas":"incompleto"})}}}else if(d){const y=Array.from(u.keys());for(const O of y)(u.get(O)||new Set).size>=o&&(g+=1);const w=Math.max(0,d-y.length);w>0&&v.push({pid:"desconocidos",label:`${w} predio(s) sin registrar en respuestas`,estado:"faltante"})}else{const y=Array.from(f.keys());for(const w of y){const O=u.get(w)||new Set;if(O.size>=o)g+=1;else{const R=f.get(w)||(w==="unknown"?"Predio desconocido":`Predio ${w}`);v.push({pid:w,label:R,estado:O.size===0?"sin respuestas":"incompleto"})}}}const E=p>0?Math.round(g/p*100):0,_=document.createElement("div");_.style.display="flex",_.style.alignItems="center",_.style.gap="14px";const m=document.createElement("div");m.innerHTML=`
    <svg class="progress-ring" viewBox="0 0 120 120" width="240" height="240" aria-label="Predios evaluados completamente">
      <circle cx="60" cy="60" r="52" stroke="#e0e0e0" stroke-width="12" fill="none"/>
      <circle id="ringFullEval" cx="60" cy="60" r="52" stroke="var(--primary-green)"
              stroke-width="12" fill="none" stroke-linecap="round"
              transform="rotate(-90 60 60)" stroke-dasharray="326 326" stroke-dashoffset="326"/>
      <text id="ringText" x="60" y="66" text-anchor="middle" font-size="20" fill="var(--color-accent-navy)" font-weight="700">${E}%</text>
    </svg>`;const b=document.createElement("div");b.innerHTML=`<div class="small">Predios evaluados completamente</div>
                        <div style="font-weight:700; font-size:1.1rem; color:var(--color-accent-navy)">${g} / ${p}  ${E}%</div>`,_.appendChild(m),_.appendChild(b),s.appendChild(_);try{const y=m.querySelector("#ringFullEval"),w=2*Math.PI*52;y.style.strokeDasharray=`${w} ${w}`,y.style.strokeDashoffset=`${w}`,requestAnimationFrame(()=>{y.style.transition="stroke-dashoffset 800ms ease";const O=w-Math.max(0,Math.min(100,E))/100*w;y.style.strokeDashoffset=`${O}`})}catch{}const T=document.createElement("div");if(T.className="small",v.length){const y=document.createElement("div");y.style.display="flex",y.style.flexDirection="column",y.style.gap="4px",y.style.minWidth="260px";const w=document.createElement("h3");w.textContent="Predios faltantes por evaluar:";const O=document.createElement("ul");O.style.margin="0",O.style.paddingLeft="18px",v.forEach(R=>{const V=document.createElement("li");V.textContent=`${R.label}  ${R.estado}`,R.estado==="sin respuestas"?V.style.color="var(--color-accent-navy)":R.estado==="incompleto"&&(V.style.color="var(--primary-orange)"),O.appendChild(V)}),y.appendChild(w),y.appendChild(O),_.appendChild(y)}else{const y=document.createElement("div");y.className="small",y.textContent="Todos los predios estn evaluados completamente.",_.appendChild(y)}e.appendChild(s);const A=document.createElement("div");A.id="app-histograma-coverage",A.style.marginBottom="24px",e.appendChild(A);try{await Hn(A)}catch(y){console.warn("No se pudo renderizar histograma de respuestas:",y)}const P=document.createElement("div");P.id="app-alertas-ia",P.style.marginBottom="24px",e.appendChild(P);try{await Kn(P)}catch(y){console.warn("No se pudieron renderizar alertas IA:",y)}const D=document.createElement("h3");D.textContent="Avance por predio",t.appendChild(D);const U=document.createElement("div");if(U.className="small",U.textContent="Porcentaje de cumplimiento por predio (respuestas con valor 5 representan cumplimiento total)",t.appendChild(U),h.size===0){const y=document.createElement("div");y.textContent="No hay respuestas registradas por predio.",t.appendChild(y),e.appendChild(t);return}const Z=document.createElement("div");Z.className="progress-container",Array.from(h.entries()).map(([y,w])=>{const O=Math.round(w.total5/o*100);return{pid:y,stats:w,percent:O}}).sort((y,w)=>w.percent-y.percent).forEach(y=>{const w=document.createElement("div");w.className="progress-row";const O=String(y.pid),R=f.get(O),V=R||(y.pid==="unknown"?"Predio desconocido":`Predio ${y.pid}`),J=document.createElement("div");J.className="progress-label",J.textContent=`${V}  ${y.percent}%`;const ue=document.createElement("div");ue.className="progress-bar";const j=document.createElement("div");j.className="progress-fill",j.style.width=Math.min(100,Math.max(0,y.percent))+"%",ue.appendChild(j),w.appendChild(J),w.appendChild(ue),Z.appendChild(w)}),t.appendChild(Z);const $=document.createElement("div");$.id="app-capitulos-progress",$.style.marginTop="24px",t.appendChild($);try{await Fn($)}catch(y){console.warn("No se pudieron renderizar promedios por captulo:",y)}e.appendChild(t)}async function Mn(){let r=[];try{const{data:o,error:c}=await N.from("preguntas").select("id,codigo");if(c)throw c;r=o||[]}catch(o){return console.error("Error cargando preguntas para captulos:",o),[]}const e=new Map;for(const o of r){if(!o||!o.id||!o.codigo)continue;const l=String(o.codigo).trim().split(".")[0],d=parseInt(l,10);Number.isNaN(d)||e.set(Number(o.id),d)}let t=[];try{const{data:o,error:c}=await N.from("respuestas").select("predio_id,pregunta_id,valor");if(c)throw c;t=o||[]}catch(o){return console.error("Error cargando respuestas para captulos:",o),[]}let s=[];try{const{data:o,error:c}=await N.from("predios").select("id,nombre");if(c)throw c;s=o||[]}catch(o){console.warn("No se pudieron cargar nombres de predios:",o)}const i=new Map;for(const o of s)i.set(String(o.id),o.nombre??`Predio ${o.id}`);const n=new Map;for(const o of t){const c=String(o.predio_id),l=e.get(Number(o.pregunta_id));if(!l)continue;const d=n.get(c)||new Map,h=d.get(l)||{sum:0,count:0};h.sum+=Number(o.valor)||0,h.count+=1,d.set(l,h),n.set(c,d)}const a=[];for(const[o,c]of n.entries()){const l=[];let d=0,h=0;for(const[f,p]of c.entries()){const g=p.count>0?p.sum/p.count:0;l.push({capitulo:f,promedio:parseFloat(g.toFixed(2)),cantidad:p.count}),d+=g,h+=1}l.sort((f,p)=>f.capitulo-p.capitulo);const u=h>0?d/h:0;a.push({predio_id:o,nombre:i.get(o)||`Predio ${o}`,capitulos:l,promedioGlobal:parseFloat(u.toFixed(2))})}return a.sort((o,c)=>c.promedioGlobal-o.promedioGlobal),a}function rs(r){return r>=4.5?"var(--primary-green)":r>=3.5?"#36b49f":r>=2.5?"var(--primary-orange)":r>=1.5?"#d57f00":"var(--color-accent-red)"}async function Fn(r="#app-capitulos"){const e=typeof r=="string"?document.querySelector(r):r;if(!e)return[];e.innerHTML="";const t=document.createElement("div");t.className="card";const s=document.createElement("h3");s.textContent="Promedios por captulo",t.appendChild(s);const i=document.createElement("div");i.className="small",i.textContent="Promedio de valores por captulo (cdigo de pregunta) agrupado por predio.",t.appendChild(i);const n=await Mn();if(!n.length){const c=document.createElement("div");return c.className="small",c.textContent="No hay respuestas suficientes para calcular promedios.",t.appendChild(c),e.appendChild(t),n}const a=document.createElement("div");a.className="chapter-indicators",n.forEach(c=>{const l=document.createElement("div");l.className="chapter-item";const d=document.createElement("div");d.className="chapter-header",d.innerHTML=`<strong>${c.nombre}</strong> <span class="chapter-global" style="background:${rs(c.promedioGlobal)}">${c.promedioGlobal.toFixed(2)}</span>`,l.appendChild(d);const h=document.createElement("div");h.className="chapter-cap-list",c.capitulos.forEach(u=>{const f=document.createElement("div");f.className="chapter-cap",f.innerHTML=`<span class="cap-number">${u.capitulo}</span><span class="cap-prom" style="background:${rs(u.promedio)}">${u.promedio.toFixed(2)}</span>`,h.appendChild(f)}),l.appendChild(h),a.appendChild(l)}),t.appendChild(a);const o=document.createElement("div");return o.className="chapter-explainer",o.innerHTML=`
    <h4>Captulos y clusulas</h4>
    <ul class="chapter-clauses">
      <li><strong>1. Contexto de la organizacin</strong>  Clusula 4</li>
      <li><strong>2. Liderazgo</strong>  Clusula 5</li>
      <li><strong>3. Planificacin</strong>  Clusula 6</li>
      <li><strong>4. Apoyo</strong>  Clusula 7</li>
      <li><strong>5. Operacin</strong>  Clusula 8</li>
      <li><strong>6. Evaluacin del desempeo</strong>  Clusula 9</li>
      <li><strong>7. Mejora</strong>  Clusula 10</li>
    </ul>
  `,t.appendChild(o),e.appendChild(t),n}async function Vn(){const r={1:0,2:0,3:0,4:0,5:0};try{const{count:e,error:t}=await N.from("respuestas").select("valor",{count:"exact",head:!0});t&&console.warn("No se pudo obtener count global respuestas:",t.message||t);let s=!1;try{const{data:n,error:a}=await N.from("respuestas").select("valor, count:valor",{group:"valor"});if(!a&&Array.isArray(n)&&n.length){let o=!1;for(const c of n)if("count"in c){o=!0;break}if(o){for(const l of n){const d=String(l.valor);r[d]!==void 0&&(r[d]=Number(l.count)||0)}s=!0;const c=Object.values(r).reduce((l,d)=>l+Number(d),0);if(e!=null&&c!==e){console.warn("Agrupacin inconsistente, se har conteo preciso por valor. suma=",c,"total=",e),s=!1;for(const l of Object.keys(r))r[l]=0}}}}catch(n){console.warn("Error intentando agrupacin:",n.message||n)}if(!s)for(let n=1;n<=5;n++)try{const{count:a,error:o}=await N.from("respuestas").select("valor",{count:"exact",head:!0}).eq("valor",n);if(o){console.warn("Error count valor",n,o.message||o);continue}r[String(n)]=Number(a||0)}catch(a){console.warn("Excepcin contando valor",n,a)}const i=Object.values(r).reduce((n,a)=>n+Number(a),0);if(e!=null&&i!==e){console.warn("Conteo por head no sum total esperado, se intentar paginacin para recomputar.");for(const c of Object.keys(r))r[c]=0;const n=1e3;let a=0,o=!1;for(;!o;){const c=a+n-1,{data:l,error:d}=await N.from("respuestas").select("valor").range(a,c);if(d){console.warn("Error paginando respuestas:",d.message||d);break}if(!l||l.length===0)break;for(const h of l){const u=String(h.valor);r[u]!==void 0&&r[u]++}l.length<n?o=!0:a+=n}}return r}catch(e){return console.error("getHistogramaRespuestas error fatal:",e),r}}async function Hn(r="#app-histograma"){const e=typeof r=="string"?document.querySelector(r):r;if(!e)return;e.innerHTML="";const t=document.createElement("div");t.className="card alert-card";const s=document.createElement("h3");s.textContent="Distribucin de respuestas (15)",t.appendChild(s);const i=document.createElement("div");i.className="small",i.textContent="Conteo total de calificaciones registradas.",t.appendChild(i);const n=await Vn(),a=Object.values(n).reduce((d,h)=>d+Number(h),0),o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.gap="6px",o.style.marginTop="10px";const c=Math.max(1,...Object.values(n));for(let d=1;d<=5;d++){const h=n[String(d)]||0,u=document.createElement("div");u.style.display="flex",u.style.alignItems="center",u.style.gap="10px";const f=document.createElement("div");f.style.width="34px",f.style.fontWeight="600",f.style.textAlign="right",f.textContent=d+":";const p=document.createElement("div");p.style.flex="1",p.style.height="16px",p.style.background="rgba(0,0,0,0.08)",p.style.borderRadius="10px",p.style.overflow="hidden";const g=document.createElement("div");g.style.height="100%",g.style.width=h/c*100+"%",g.style.background="var(--primary-green)",g.style.transition="width 600ms ease",p.appendChild(g);const v=document.createElement("div");v.style.width="70px",v.style.textAlign="left",v.style.fontSize="0.85rem",v.textContent=`${h} resp.`,v.setAttribute("aria-label",`Valor ${d} tiene ${h} respuestas`),u.appendChild(f),u.appendChild(p),u.appendChild(v),o.appendChild(u)}const l=document.createElement("div");l.className="small",l.style.marginTop="6px",l.textContent=`Total de respuestas: ${a}`,t.appendChild(o),t.appendChild(l),e.appendChild(t)}async function Wn(r={}){const{recientes:e=!0,dias:t=30}=r,s=e?new Date(Date.now()-t*24*60*60*1e3).toISOString():null;let i=[];try{let d=N.from("respuestas").select("id,valor,observacion,predio_id,pregunta_id,fecha");e&&s&&(d=d.gte("fecha",s));const{data:h,error:u}=await d.order("fecha",{ascending:!1});if(u)throw u;i=(h||[]).filter(f=>f.observacion&&String(f.observacion).trim().length>3)}catch(d){return console.warn("Error obteniendo observaciones:",d.message||d),[]}if(!i.length)return[];const n=[{categoria:"Incumplimiento",kws:["no cumple","incumpl","falta de cumplimiento","no se realiz","omitido"]},{categoria:"Falta de recursos",kws:["sin presupuesto","no hay recursos","equipamiento insuficiente","falta de personal","carencia"]},{categoria:"Riesgo ambiental",kws:["derrame","contamin","residuo","riesgo","impacto ambiental","emisin"]},{categoria:"Capacitacin requerida",kws:["capacitacin","entrenamiento","formacin","no capacitado","desconoce procedimiento"]},{categoria:"Documento desactualizado",kws:["documento desactualizado","manual antiguo","procedimiento viejo","no actualizado"]},{categoria:"Procedimiento no aplicado",kws:["no se aplica","no aplicado","no sigui el procedimiento","sin seguir protocolo","salt el proceso"]},{categoria:"Oportunidad de mejora",kws:["mejorar","optimizar","podra","se sugiere","recomienda","oportunidad"]}],a={Incumplimiento:"Realizar revisin inmediata y aplicar correcciones documentadas.","Falta de recursos":"Evaluar necesidades y asignar presupuesto o personal adicional.","Riesgo ambiental":"Implementar medidas de mitigacin y monitoreo; registrar incidente.","Capacitacin requerida":"Planificar sesin de formacin y verificar comprensin posterior.","Documento desactualizado":"Actualizar documento y comunicar nueva versin al equipo.","Procedimiento no aplicado":"Reforzar cumplimiento mediante auditora interna y seguimiento.","Oportunidad de mejora":"Registrar en plan de mejora continua y priorizar segn impacto."};function o(d){const h=d.toLowerCase();for(const u of n)for(const f of u.kws)if(h.includes(f))return u.categoria;return"Oportunidad de mejora"}function c(d,h){const u=Number(d);return["Riesgo ambiental","Incumplimiento"].includes(h)&&u<=3||u<=2?"alto":u===3||u===4?"medio":"bajo"}return i.map(d=>{const h=o(String(d.observacion)),u=c(d.valor,h),f=a[h]||"Registrar accin correctiva.",p=`La observacin sugiere ${h.toLowerCase()}: "${String(d.observacion).slice(0,180)}"`;return{respuesta_id:d.id,alerta:{nivel:u,categoria:h,descripcion:p,accion_recomendada:f}}})}async function Kn(r="#app-alertas-ia"){const e=typeof r=="string"?document.querySelector(r):r;if(!e)return[];e.innerHTML="";const t=document.createElement("div");t.className="card";const s=document.createElement("h3");s.textContent="Alertas automticas (IA)",t.appendChild(s);const i=document.createElement("div");i.className="small",i.textContent="Clasificacin preliminar de observaciones por categora y nivel.",t.appendChild(i);const n=await Wn({recientes:!0,dias:30});if(!n.length){const l=document.createElement("div");return l.className="small",l.textContent="No hay observaciones clasificables en el perodo seleccionado.",t.appendChild(l),e.appendChild(t),n}const a=new Map;for(const l of n){const d=l.alerta.categoria,h=l.alerta.nivel,u=a.get(d)||{total:0,alto:0,medio:0,bajo:0};u.total++,u[h]++,a.set(d,u)}const o=document.createElement("div");o.className="alerts-grid";for(const[l,d]of a.entries()){const h=document.createElement("div");h.className="alert-category-item",h.innerHTML=`<strong>${l}</strong>
      <div class='alert-total'>${d.total} alerta(s)</div>
      <div class='alert-badges'>
        <span class='alert-badge level-alto'>Alto ${d.alto}</span>
        <span class='alert-badge level-medio'>Medio ${d.medio}</span>
        <span class='alert-badge level-bajo'>Bajo ${d.bajo}</span>
      </div>`,o.appendChild(h)}t.appendChild(o);const c=n.filter(l=>l.alerta.nivel==="alto").slice(0,10);if(c.length){const l=document.createElement("div");l.className="alertas-altas";const d=document.createElement("h4");d.textContent="Alertas de nivel alto (top 10)",l.appendChild(d);const h=document.createElement("ul");c.forEach(u=>{const f=document.createElement("li");f.innerHTML=`<strong>#${u.respuesta_id}</strong> [${u.alerta.categoria}] ${u.alerta.descripcion}<br/><em>Accin: ${u.alerta.accion_recomendada}</em>`,h.appendChild(f)}),l.appendChild(h),t.appendChild(l)}return e.appendChild(t),n}console.log("[login.js] cargado");const Jn="https://hkxugotjfkyalmlkojhq.supabase.co",Gn="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhreHVnb3RqZmt5YWxtbGtvamhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODk3MTAsImV4cCI6MjA3Nzc2NTcxMH0.mV21rbO4K5gfmYWF_ZB5mcjPG2TLu80w0SOMBCoDkaE",_e=fr(Jn,Gn),ur=document.getElementById("app");function Fe(){ur.innerHTML=`
    <section class="login-container">
        <h2>Iniciar sesin</h2>
        <form id="loginForm">
            <div class="input-box">
                <i></i>
                <input type="email" id="email" placeholder="Correo electrnico" required />
            </div>
            <div class="input-box">
                <i></i>
                <input type="password" id="password" placeholder="Contrasea" required />
            </div>
            <button type="submit" class="btn">Entrar</button>
        </form>

        <p style="margin:16px 0;"></p>  
        <p>No tienes cuenta? <a href="#" id="signupLink">Regstrate</a></p>

        <div id="register" style="display:none; margin-top:20px;">
            <h2>Crear cuenta</h2>
            <div class="input-box">
                <i></i>
                <input type="email" id="regEmail" placeholder="Correo electrnico" />
            </div>
            <div class="input-box">
                <i></i>
                <input type="password" id="regPass" placeholder="Contrasea" />
            </div>
            <button id="btnRegister" class="btn">Registrar</button>
        </div>
    </section>
`,document.body.classList.add("auth-page"),document.getElementById("loginForm").addEventListener("submit",Yn),document.getElementById("signupLink").addEventListener("click",Zn),document.getElementById("btnRegister").addEventListener("click",Qn)}async function hr(r){ur.innerHTML=`
    <nav>
      <label class="logo">Bienvenido, ${(r==null?void 0:r.email)||"Invitado"}</label>
      <ul>
          <li><a href="#" id="tabAvance">Dashboard</a></li>
          <li><a href="#" id="tabResponder">Calificar</a></li>
          <li><a href="#" id="tabRespuestas">Respuestas</a></li>
          ${r?'<li><a href="#" id="btnLogout" class="btn btn-danger">Salir</a></li>':'<li><a href="#" id="btnLogin" class="btn">Entrar</a></li>'}
      </ul>
    </nav>
    <main id="dashboardContent" class="dashboard-main"></main>
  `,document.body.classList.remove("auth-page");const e=document.getElementById("btnLogout");e&&e.addEventListener("click",Xn);const t=document.getElementById("btnLogin");t&&t.addEventListener("click",l=>{l.preventDefault(),Fe()});const s=document.getElementById("dashboardContent"),i=document.getElementById("tabResponder"),n=document.getElementById("tabAvance"),a=document.getElementById("tabRespuestas");function o(l){[i,n,a].forEach(d=>d&&d.classList.remove("active")),l&&l.classList.add("active")}async function c(l){if(s){s.innerHTML="";try{if(l==="responder"){const{data:{session:d}}=await _e.auth.getSession();if(!d||!d.user){s.innerHTML=`
            <div class="card">
              <h3>Inicia sesin para calificar</h3>
              <p class="small">Para responder preguntas necesitas una cuenta activa.</p>
              <button id="goLogin1" class="btn">Entrar</button>
            </div>`;const h=document.getElementById("goLogin1");h==null||h.addEventListener("click",()=>Fe());return}await zn("#dashboardContent")}else if(l==="avance")await dr("#dashboardContent");else if(l==="respuestas"){const{data:{session:d}}=await _e.auth.getSession();if(!d||!d.user){s.innerHTML=`
            <div class="card">
              <h3>Inicia sesin para ver respuestas</h3>
              <p class="small">El listado de respuestas requiere autenticacin.</p>
              <button id="goLogin2" class="btn">Entrar</button>
            </div>`;const h=document.getElementById("goLogin2");h==null||h.addEventListener("click",()=>Fe());return}await lr("#dashboardContent")}}catch(d){console.error("Error cargando vista",l,d)}}}i==null||i.addEventListener("click",async l=>{l.preventDefault(),o(i),await c("responder")}),n==null||n.addEventListener("click",async l=>{l.preventDefault(),o(n),await c("avance")}),a==null||a.addEventListener("click",async l=>{l.preventDefault(),o(a),await c("respuestas")}),o(n),await c("avance")}async function Yn(r){r.preventDefault();const e=document.getElementById("email").value.trim(),t=document.getElementById("password").value.trim(),{data:s,error:i}=await _e.auth.signInWithPassword({email:e,password:t});if(i)return alert(" "+i.message);hr(s.user)}async function Qn(){const r=document.getElementById("regEmail").value.trim(),e=document.getElementById("regPass").value.trim(),{error:t}=await _e.auth.signUp({email:r,password:e});if(t)return alert(" "+t.message);alert(" Cuenta creada. Revisa tu correo para confirmar.")}async function Xn(r){r&&typeof r.preventDefault=="function"&&r.preventDefault(),await _e.auth.signOut(),Fe()}function Zn(r){r.preventDefault();const e=document.getElementById("register");e.style.display=e.style.display==="none"?"block":"none"}window.onload=async()=>{const{data:{session:r}}=await _e.auth.getSession();await hr((r==null?void 0:r.user)||null)};
